/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements. 
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.aiops_bundle_jsonpfunction=window.aiops_bundle_jsonpfunction||[]).push([[3],{311:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=a(19).__importDefault(a(312));t.default=function(e){i.default((function(){e()}))}},312:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=a(1);t.default=function(e){i.useEffect(e,[])}},315:function(e,t,a){"use strict";a.r(t);var i=a(1),s=a.n(i),n=a(2),r=a(43);const l=Object(i.createContext)({get dataView(){throw new Error("Context is not implemented")},savedSearch:null});function o(){return Object(i.useContext)(l)}var c=a(51),u=a(89),d=a(90),b=a(0);const p=()=>{const[,e]=Object(r.d)("_g"),{dataView:t}=o(),a=Object(c.c)({timeRangeSelector:void 0!==t.timeFieldName,autoRefreshSelector:!0}),l=Object(i.useCallback)((t=>{e({time:{from:t.start.string,to:t.end.string}})}),[e]);return Object(b.jsx)(s.a.Fragment,null,Object(b.jsx)(n.EuiFlexGroup,{gutterSize:"none"},Object(b.jsx)(n.EuiFlexItem,null,Object(b.jsx)(n.EuiPageContentHeader_Deprecated,{className:"aiopsPageHeader"},Object(b.jsx)(n.EuiPageContentHeaderSection_Deprecated,null,Object(b.jsx)("div",{className:"dataViewTitleHeader"},Object(b.jsx)(n.EuiTitle,{size:"s"},Object(b.jsx)("h2",null,t.getName())))),Object(b.jsx)(n.EuiFlexGroup,{alignItems:"center",justifyContent:"flexEnd",gutterSize:"s","data-test-subj":"aiopsTimeRangeSelectorSection"},void 0!==t.timeFieldName&&Object(b.jsx)(n.EuiFlexItem,{grow:!1},Object(b.jsx)(u.a,{dataView:t,query:void 0,disabled:!1,timefilter:a,callback:l})),Object(b.jsx)(n.EuiFlexItem,{grow:!1},Object(b.jsx)(d.a,null)))))),Object(b.jsx)(n.EuiSpacer,null))};var g=a(14),j=a(311),m=a.n(j),x=a(45),f=a(29),O=a(7),y=a(13),h=a(18);function v(){const{data:e}=Object(f.b)(),t=Object(i.useRef)(new AbortController),[a,s]=Object(i.useState)(!1);return{runRequest:Object(i.useCallback)((a=>new Promise(((i,n)=>{e.search.search(a,{abortSignal:t.current.signal}).pipe(Object(h.tap)((()=>{s(!0)}))).subscribe({next:e=>{Object(y.isCompleteResponse)(e)?(s(!1),i(e)):Object(y.isErrorResponse)(e)&&n(e)},error:e=>{if("AbortError"===e.name)return i(null);n(e)}})}))),[e.search]),cancelRequest:Object(i.useCallback)((()=>{t.current.abort(),t.current=new AbortController}),[]),isLoading:a}}var F=a(142);const _=Object(i.createContext)({isLoading:!1,splitFieldsOptions:[],metricFieldOptions:[],requestParams:{},timeBuckets:{},bucketInterval:{},updateRequestParams:()=>{},annotations:[],resultFilters:[],updateFilters:()=>{},resultQuery:{query:"",language:"kuery"},progress:0,pagination:{activePage:0,pageCount:1,updatePagination:()=>{}}}),E=({children:e})=>{const{dataView:t,savedSearch:a}=o(),{uiSettings:s,data:{query:{filterManager:n}}}=Object(f.b)(),l=Object(i.useMemo)((()=>Object(x.c)({dataView:t,uiSettings:s,savedSearch:a,filterManager:n})),[t,a,s,n]),u=Object(c.c)(),d=Object(F.a)(),[p,j]=Object(i.useState)([]),[y,h]=Object(i.useState)(),E=Object(c.b)();m()((function(){const e=u.getTimeUpdate$().pipe(Object(g.startWith)(u.getTime())).subscribe((()=>{const e=u.getActiveBounds();if(!e)throw new Error("Time bound not available");d.setInterval("auto"),d.setBounds(e),h(d.getInterval())}));return()=>{e.unsubscribe()}}));const w=Object(i.useMemo)((()=>t.fields.filter((({aggregatable:e,type:t})=>e&&"number"===t))),[t]),C=Object(i.useMemo)((()=>t.fields.filter((({aggregatable:e,esTypes:t,displayName:a})=>e&&t&&t.includes("keyword")&&!["_id","_index"].includes(a)))),[t]),[P,S]=Object(r.c)("changePoint"),k=Object(i.useMemo)((()=>{var e,t,a;return null!==(e=P.query)&&void 0!==e?e:{query:null!==(t=null==l?void 0:l.searchString)&&void 0!==t?t:"",language:null!==(a=null==l?void 0:l.queryLanguage)&&void 0!==a?a:"kuery"}}),[l,P.query]),q=Object(i.useMemo)((()=>{const e={...P};return e.fn||(e.fn="min"),!e.metricField&&w.length>0&&(e.metricField=w[0].name),!e.splitField&&C.length>0&&(e.splitField=C[0].name),e.interval=null==y?void 0:y.expression,e}),[P,w,C,y]),M=Object(i.useCallback)((e=>{n.setFilters(e)}),[n]);m()((()=>{j(n.getFilters());const e=n.getUpdates$().subscribe((()=>{j(n.getFilters())}));return()=>{e.unsubscribe()}})),Object(i.useEffect)((function(){const e=null==n?void 0:n.getGlobalFilters();P.filters&&n.setFilters(P.filters),e&&(null==n||n.addFilters(e))}),[P.filters,n]);const T=Object(i.useMemo)((()=>{var e;const a=Object(x.b)(k,p,t,s);return Array.isArray(null===(e=a.bool)||void 0===e?void 0:e.filter)||(a.bool||(a.bool={}),a.bool.filter=[]),a.bool.filter.push({range:{[t.timeFieldName]:{from:E.from,to:E.to}}}),a}),[p,k,s,t,E]),{results:I,isLoading:R,progress:z,pagination:N}=function(e,t){const{notifications:{toasts:a}}=Object(f.b)(),{dataView:s}=o(),[n,r]=Object(i.useState)([]),[l,c]=Object(i.useState)(0),[u,d]=Object(i.useState)(0),b=function(e,t){const[a,s]=Object(i.useState)(),{dataView:n}=o(),r=Object(i.useMemo)((()=>({params:{index:n.getIndexPattern(),size:0,body:{query:t,aggregations:{fieldCount:{cardinality:{field:e}}}}}})),[e,n,t]),{runRequest:l,cancelRequest:c}=v();return Object(i.useEffect)((function(){c(),l(r).then((e=>{null!=e&&e.rawResponse.aggregations&&s(e.rawResponse.aggregations.fieldCount.value)}))}),[l,r,c]),a}(e.splitField,t),{runRequest:p,cancelRequest:g,isLoading:j}=v(),m=Object(i.useCallback)((()=>{g(),d(0),c(0),r([])}),[g]),x=Object(i.useCallback)((async(i,n)=>{try{var l;if(!b)return void d(100);const a=function({index:e,fn:t,metricField:a,splitField:i,timeInterval:s,timeField:n,afterKey:r},l){return{params:{index:e,size:0,body:{query:l,aggregations:{groupings:{composite:{size:500,...void 0!==r?{after:{splitFieldTerm:r}}:{},sources:[{splitFieldTerm:{terms:{field:i}}}]},aggregations:{over_time:{date_histogram:{field:n,fixed_interval:s},aggs:{function_value:{[t]:{field:a}}}},change_point_request:{change_point:{buckets_path:"over_time>function_value"}},select:{bucket_selector:{buckets_path:{p_value:"change_point_request.p_value"},script:"params.p_value < 1"}},sort:{bucket_sort:{sort:[{"change_point_request.p_value":{order:"asc"}}]}}}}}}}}}({index:s.getIndexPattern(),fn:e.fn,timeInterval:e.interval,metricField:e.metricField,timeField:s.timeFieldName,splitField:e.splitField,afterKey:i},t),o=await p(a);if(null===o)return void d(100);const c=o.rawResponse.aggregations.groupings.buckets;d(Math.min(Math.round((c.length+(null!=n?n:0))/b*100),100));const u=c.map((e=>{var t;const a=Object.keys(e.change_point_request.type)[0],i=null===(t=e.change_point_request.bucket)||void 0===t?void 0:t.key,s=e.change_point_request.type[a].p_value;return{group_field:e.key.splitFieldTerm,type:a,p_value:s,timestamp:i,label:a,reason:e.change_point_request.type[a].reason}}));r((e=>(null!=e?e:[]).concat(u).sort(((e,t)=>e.p_value-t.p_value)))),null!==(l=o.rawResponse.aggregations.groupings.after_key)&&void 0!==l&&l.splitFieldTerm?await x(o.rawResponse.aggregations.groupings.after_key.splitFieldTerm,c.length+(null!=n?n:0)):d(100)}catch(e){a.addError(e,{title:O.i18n.translate("xpack.aiops.changePointDetection.fetchErrorTitle",{defaultMessage:"Failed to fetch change points"})})}}),[p,e,t,s,b,a]);Object(i.useEffect)((function(){return m(),x(),()=>{g()}}),[e,t,b,x,m,g]);const y=Object(i.useMemo)((()=>{var e;return{activePage:l,pageCount:Math.round((null!==(e=n.length)&&void 0!==e?e:0)/6),updatePagination:c}}),[l,n.length]);return{results:Object(i.useMemo)((()=>{const e=6*l;return n.slice(e,e+6)}),[n,l]),isLoading:j,reset:m,progress:u,pagination:y}}(q,T);if(!y)return null;const L={isLoading:R,progress:z,timeBuckets:d,requestParams:q,updateRequestParams:S,metricFieldOptions:w,splitFieldsOptions:C,annotations:I,bucketInterval:y,resultFilters:p,updateFilters:M,resultQuery:k,pagination:N};return Object(b.jsx)(_.Provider,{value:L},e)};function w(){return Object(i.useContext)(_)}var C=a(10),P=a(12);const S=({query:e,filters:t,onQueryChange:a,onFiltersChange:r})=>{const{dataView:l}=o(),{unifiedSearch:{ui:{SearchBar:c}}}=Object(f.b)(),[u,d]=Object(i.useState)(),p=Object(i.useCallback)(((e,t)=>{if(e.query.language===x.a.KUERY)try{Object(P.fromKueryExpression)(e.query.query),d(void 0),a(e.query)}catch(e){d(e.message)}}),[a]),g=Object(i.useCallback)((e=>{r(e)}),[r]),j=null!=e?e:{query:"",language:"kuery"};return Object(b.jsx)(s.a.Fragment,null,Object(b.jsx)(c,{showSubmitButton:!1,appName:"aiops",showFilterBar:!0,showDatePicker:!1,showQueryInput:!0,query:j,filters:null!=t?t:[],onQuerySubmit:p,indexPatterns:[l],placeholder:O.i18n.translate("xpack.aiops.searchPanel.queryBarPlaceholderText",{defaultMessage:'Searchâ€¦ (e.g. status:200 AND extension:"PHP")'}),displayStyle:"inPage",isClearable:!0,onFiltersUpdated:g}),u?Object(b.jsx)(s.a.Fragment,null,Object(b.jsx)(n.EuiSpacer,{size:"s"}),Object(b.jsx)(n.EuiTextColor,{color:"danger"},u)):null)},k=s.a.memo((({value:e,onChange:t})=>{const{metricFieldOptions:a}=w(),s=Object(i.useMemo)((()=>a.map((e=>({value:e.name,text:e.displayName})))),[a]);return Object(b.jsx)(n.EuiFormRow,null,Object(b.jsx)(n.EuiSelect,{prepend:O.i18n.translate("xpack.aiops.changePointDetection.selectMetricFieldLabel",{defaultMessage:"Metric field"}),options:s,value:e,onChange:e=>t(e.target.value)}))})),q=s.a.memo((({value:e,onChange:t})=>{const{splitFieldsOptions:a}=w(),s=Object(i.useMemo)((()=>a.map((e=>({value:e.name,text:e.displayName})))),[a]);return Object(b.jsx)(n.EuiFormRow,null,Object(b.jsx)(n.EuiSelect,{prepend:O.i18n.translate("xpack.aiops.changePointDetection.selectSpitFieldLabel",{defaultMessage:"Split field"}),options:s,value:e,onChange:e=>t(e.target.value)}))})),M={min:"min",max:"max",sum:"sum",avg:"average"},T=s.a.memo((({value:e,onChange:t})=>{const a=Object.keys(M).map((e=>({value:e,text:e})));return Object(b.jsx)(n.EuiFormRow,null,Object(b.jsx)(n.EuiSelect,{options:a,value:e,onChange:e=>t(e.target.value),prepend:O.i18n.translate("xpack.aiops.changePointDetection.selectFunctionLabel",{defaultMessage:"Function"})}))})),I=s.a.memo((({annotation:e})=>{const{lens:{EmbeddableComponent:t}}=Object(f.b)(),a=Object(c.b)(),{dataView:s}=o(),{requestParams:n,bucketInterval:r}=w(),l=Object(i.useMemo)((()=>[{meta:{index:s.id,alias:null,negate:!1,disabled:!1,type:"phrase",key:n.splitField,params:{query:e.group_field}},query:{match_phrase:{[n.splitField]:e.group_field}},$state:{store:P.FilterStateStore.APP_STATE}}]),[s.id,n.splitField,e.group_field]),u=Object(i.useMemo)((()=>({title:e.group_field,description:"",visualizationType:"lnsXY",type:"lens",references:[{type:"index-pattern",id:s.id,name:"indexpattern-datasource-layer-2d61a885-abb0-4d4e-a5f9-c488caec3c22"},{type:"index-pattern",id:s.id,name:"xy-visualization-layer-8d26ab67-b841-4877-9d02-55bf270f9caf"}],state:{visualization:{legend:{isVisible:!1,position:"right"},valueLabels:"hide",fittingFunction:"None",axisTitlesVisibilitySettings:{x:!0,yLeft:!0,yRight:!0},tickLabelsVisibilitySettings:{x:!0,yLeft:!0,yRight:!0},labelsOrientation:{x:0,yLeft:0,yRight:0},gridlinesVisibilitySettings:{x:!0,yLeft:!0,yRight:!0},preferredSeriesType:"line",layers:[{layerId:"2d61a885-abb0-4d4e-a5f9-c488caec3c22",accessors:["e9f26d17-fb36-4982-8539-03f1849cbed0"],position:"top",seriesType:"line",showGridlines:!1,layerType:"data",xAccessor:"877e6638-bfaa-43ec-afb9-2241dc8e1c86"},...e.timestamp?[{layerId:"8d26ab67-b841-4877-9d02-55bf270f9caf",layerType:"annotations",annotations:[{type:"manual",label:e.label,icon:"triangle",textVisibility:!0,key:{type:"point_in_time",timestamp:e.timestamp},id:"a8fb297c-8d96-4011-93c0-45af110d5302",isHidden:!1,color:"#F04E98",lineStyle:"solid",lineWidth:2,outside:!1}],ignoreGlobalFilters:!0}]:[]]},query:{query:"",language:"kuery"},filters:l,datasourceStates:{formBased:{layers:{"2d61a885-abb0-4d4e-a5f9-c488caec3c22":{columns:{"877e6638-bfaa-43ec-afb9-2241dc8e1c86":{label:s.timeFieldName,dataType:"date",operationType:"date_histogram",sourceField:s.timeFieldName,isBucketed:!0,scale:"interval",params:{interval:r.expression,includeEmptyRows:!0,dropPartials:!1}},"e9f26d17-fb36-4982-8539-03f1849cbed0":{label:`${n.fn}(${n.metricField})`,dataType:"number",operationType:M[n.fn],sourceField:n.metricField,isBucketed:!1,scale:"ratio",params:{emptyAsNull:!0}}},columnOrder:["877e6638-bfaa-43ec-afb9-2241dc8e1c86","e9f26d17-fb36-4982-8539-03f1849cbed0"],incompleteColumns:{}}}},textBased:{layers:{}}},internalReferences:[],adHocDataViews:{}}})),[s.id,s.timeFieldName,e,n,l,r]);return Object(b.jsx)(t,{id:`changePointChart_${e.group_field}`,style:{height:350},timeRange:a,attributes:u,renderMode:"view",executionContext:{type:"aiops_change_point_detection_chart",name:"Change point detection"}})})),R=()=>{const{requestParams:e,updateRequestParams:t,annotations:a,resultFilters:r,updateFilters:l,resultQuery:o,progress:c,pagination:u}=w(),d=Object(i.useCallback)((e=>{t({fn:e})}),[t]),p=Object(i.useCallback)((e=>{t({splitField:e})}),[t]),g=Object(i.useCallback)((e=>{t({metricField:e})}),[t]),j=Object(i.useCallback)((e=>{t({query:e})}),[t]),m={width:"200px"};return Object(b.jsx)("div",{"data-test-subj":"aiopsChangePointDetectionPage"},Object(b.jsx)(S,{query:o,onQueryChange:j,filters:r,onFiltersChange:l}),Object(b.jsx)(n.EuiSpacer,{size:"m"}),Object(b.jsx)(n.EuiFlexGroup,{alignItems:"center"},Object(b.jsx)(n.EuiFlexItem,{grow:!1,css:m},Object(b.jsx)(T,{value:e.fn,onChange:d})),Object(b.jsx)(n.EuiFlexItem,{grow:!1,css:m},Object(b.jsx)(k,{value:e.metricField,onChange:g})),Object(b.jsx)(n.EuiFlexItem,{grow:!1,css:m},Object(b.jsx)(q,{value:e.splitField,onChange:p})),Object(b.jsx)(n.EuiFlexItem,{css:Object(b.css)({visibility:100===c?"hidden":"visible"},"",""),grow:!1},Object(b.jsx)(n.EuiProgress,{label:Object(b.jsx)(C.FormattedMessage,{id:"xpack.aiops.changePointDetection.progressBarLabel",defaultMessage:"Fetching change points"}),value:c,max:100,valueText:!0,size:"m"}),Object(b.jsx)(n.EuiSpacer,{size:"s"}))),Object(b.jsx)(n.EuiSpacer,{size:"m"}),0===a.length&&100===c?Object(b.jsx)(s.a.Fragment,null,Object(b.jsx)(n.EuiEmptyPrompt,{iconType:"search",title:Object(b.jsx)("h2",null,Object(b.jsx)(C.FormattedMessage,{id:"xpack.aiops.changePointDetection.noChangePointsFoundTitle",defaultMessage:"No change points found"})),body:Object(b.jsx)("p",null,Object(b.jsx)(C.FormattedMessage,{id:"xpack.aiops.changePointDetection.noChangePointsFoundMessage",defaultMessage:"Try to extend the time range or update the query"}))})):null,Object(b.jsx)(n.EuiFlexGrid,{columns:a.length>=2?2:1,responsive:!0,gutterSize:"m"},a.map((e=>Object(b.jsx)(n.EuiFlexItem,{key:e.group_field},Object(b.jsx)(n.EuiPanel,{paddingSize:"s",hasBorder:!0,hasShadow:!1},Object(b.jsx)(n.EuiFlexGroup,{justifyContent:"spaceBetween",alignItems:"center"},Object(b.jsx)(n.EuiFlexItem,{grow:!1},Object(b.jsx)(n.EuiFlexGroup,{alignItems:"center",gutterSize:"s"},Object(b.jsx)(n.EuiFlexItem,{grow:!1},Object(b.jsx)(n.EuiTitle,{size:"xxs"},Object(b.jsx)("h3",null,e.group_field))),e.reason?Object(b.jsx)(n.EuiFlexItem,{grow:!1},Object(b.jsx)(n.EuiToolTip,{position:"top",content:e.reason},Object(b.jsx)(n.EuiIcon,{tabIndex:0,color:"warning",type:"alert",title:O.i18n.translate("xpack.aiops.changePointDetection.notResultsWarning",{defaultMessage:"No change point agg results warning"})}))):null)),Object(b.jsx)(n.EuiFlexItem,{grow:!1},Object(b.jsx)(n.EuiBadge,{color:"hollow"},e.type))),void 0!==e.p_value?Object(b.jsx)(n.EuiDescriptionList,{type:"inline",listItems:[{title:"p-value",description:e.p_value.toPrecision(3)}]}):null,Object(b.jsx)(I,{annotation:e})))))),Object(b.jsx)(n.EuiSpacer,{size:"m"}),u.pageCount>1?Object(b.jsx)(n.EuiFlexGroup,{justifyContent:"spaceAround"},Object(b.jsx)(n.EuiFlexItem,{grow:!1},Object(b.jsx)(n.EuiPagination,{pageCount:u.pageCount,activePage:u.activePage,onPageClick:u.updatePagination}))):null)};t.default=({dataView:e,savedSearch:t,appDependencies:a})=>Object(b.jsx)(f.a.Provider,{value:a},Object(b.jsx)(r.b,null,Object(b.jsx)(l.Provider,{value:{dataView:e,savedSearch:t}},Object(b.jsx)(p,null),Object(b.jsx)(E,null,Object(b.jsx)(R,null)))))}}]);