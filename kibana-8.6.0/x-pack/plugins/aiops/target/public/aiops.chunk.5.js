/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements. 
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.aiops_bundle_jsonpfunction=window.aiops_bundle_jsonpfunction||[]).push([[5],{316:function(e,t,a){"use strict";a.r(t);var o=a(1),s=a.n(o),i=a(7),n=a(10),l=a(2),r=a(89),c=a(90),u=a(141),d=a(144),g=a(43),j=a(29),b=a(140),p=a(9),m=a(20);var x=a(17),O=a.n(x),y=a(11),h=a.n(y),v=a(91),C=a(67),f=a(0);const k="should",S="must_not",E=({categories:e,sparkLines:t,eventRate:a,dataViewId:r,selectedField:c,timefilter:u,aiopsListState:d,pinnedCategory:g,setPinnedCategory:b,selectedCategory:p,setSelectedCategory:m})=>{const x=Object(C.a)(),y=Object(l.useEuiBackgroundColor)("primary"),{openInDiscoverWithFilter:E}=function(){const{http:{basePath:e}}=Object(j.b)();return{openInDiscoverWithFilter:(t,a,o,s,i,n,l)=>{var r,c;const u=void 0===l?o:[l],d=O.a.encode({time:{from:h()(null===(r=i.min)||void 0===r?void 0:r.valueOf()).toISOString(),to:h()(null===(c=i.max)||void 0===c?void 0:c.valueOf()).toISOString()}}),g=O.a.encode({filters:[...s.filters,{query:{bool:{[n]:u.map((({key:e})=>({match:{[a]:{auto_generate_synonyms_phrase_query:!1,fuzziness:0,operator:"and",query:e}}})))}}}],index:t,interval:"auto",query:{language:s.searchQueryLanguage,query:s.searchString}});let j=e.get();j+="/app/discover#/",j+="?_g="+d,j+="&_a="+encodeURIComponent(g),window.open(j,"_blank")}}}(),[w,z]=Object(o.useState)([]),{onTableChange:F,pagination:_,sorting:M}=function(e,t){const[a,s]=Object(o.useState)(0),[i,n]=Object(o.useState)(10),[l,r]=Object(o.useState)("key"),[c,u]=Object(o.useState)("asc");return{onTableChange:({page:e={index:0,size:10},sort:t={field:l,direction:c}})=>{const{index:a,size:o}=e;s(a),n(o);const{field:i,direction:d}=t;r(i),u(d)},pagination:{pageIndex:a,pageSize:i,totalItemCount:(null!=e?e:[]).length,pageSizeOptions:[10,20,50],showPerPageOptions:!0},sorting:{sort:{field:l,direction:c}},setPageIndex:s}}(null!=e?e:[]),P=(e,t)=>{const a=u.getActiveBounds();void 0!==a&&void 0!==c&&E(r,c,w,d,a,e,t)},I=[{field:"count",name:i.i18n.translate("xpack.aiops.logCategorization.column.count",{defaultMessage:"Count"}),sortable:!0,width:"80px"},{field:"count",name:i.i18n.translate("xpack.aiops.logCategorization.column.logRate",{defaultMessage:"Log rate"}),sortable:!0,width:"100px",render:(o,{key:s})=>{const i=t[s];if(void 0===i)return null;const n=a.map((e=>({doc_count_overall:e.docCount,doc_count_change_point:i[e.key],key:e.key,key_as_string:`${e.key}`})));return Object(f.jsx)(v.a,{chartData:n,isLoading:null===e&&void 0===n,label:""})}},{field:"examples",name:i.i18n.translate("xpack.aiops.logCategorization.column.examples",{defaultMessage:"Examples"}),sortable:!0,style:{display:"block"},render:e=>Object(f.jsx)("div",{style:{display:"block"}},e.map((e=>Object(f.jsx)(s.a.Fragment,null,Object(f.jsx)(l.EuiText,{size:"s"},Object(f.jsx)(l.EuiCode,{language:"log",transparentBackground:!0},e)),Object(f.jsx)(l.EuiSpacer,{size:"s"})))))},{name:"Actions",width:"60px",actions:[{name:i.i18n.translate("xpack.aiops.logCategorization.showInDiscover",{defaultMessage:"Show these in Discover"}),description:i.i18n.translate("xpack.aiops.logCategorization.showInDiscover",{defaultMessage:"Show these in Discover"}),icon:"discoverApp",type:"icon",onClick:e=>P(k,e)},{name:i.i18n.translate("xpack.aiops.logCategorization.filterOutInDiscover",{defaultMessage:"Filter out in Discover"}),description:i.i18n.translate("xpack.aiops.logCategorization.filterOutInDiscover",{defaultMessage:"Filter out in Discover"}),icon:"filter",type:"icon",onClick:e=>P(S,e)}]}],L={selectable:()=>!0,onSelectionChange:e=>z(e)},R=e=>g&&g.key===e.key&&g.key===e.key?{backgroundColor:y}:p&&p.key===e.key?{backgroundColor:x.euiColorLightestShade}:{backgroundColor:x.euiColorEmptyShade};return Object(f.jsx)(s.a.Fragment,null,w.length>0?Object(f.jsx)(s.a.Fragment,null,Object(f.jsx)(l.EuiFlexGroup,null,Object(f.jsx)(l.EuiFlexItem,{grow:!1},Object(f.jsx)(l.EuiButton,{size:"s",onClick:()=>P(k)},Object(f.jsx)(n.FormattedMessage,{id:"xpack.aiops.logCategorization.showInDiscover",defaultMessage:"Show these in Discover"}))),Object(f.jsx)(l.EuiFlexItem,{grow:!1},Object(f.jsx)(l.EuiButton,{size:"s",onClick:()=>P(S)},Object(f.jsx)(n.FormattedMessage,{id:"xpack.aiops.logCategorization.filterOutInDiscover",defaultMessage:"Filter out in Discover"}))))):null,Object(f.jsx)(l.EuiInMemoryTable,{compressed:!0,items:e,columns:I,isSelectable:!0,selection:L,itemId:"key",onTableChange:F,pagination:_,sorting:M,rowProps:e=>({onClick:()=>{e.key===(null==g?void 0:g.key)?b(null):b(e)},onMouseEnter:()=>{m(e)},onMouseLeave:()=>{m(null)},style:R(e)})}))};var w=a(143),z=a(145);const F=({eventRate:e,sparkLines:t,totalCount:a,pinnedCategory:n,selectedCategory:l,documentCountStats:r})=>{const c=i.i18n.translate("xpack.aiops.logCategorization.chartPointsSplitLabel",{defaultMessage:"Selected category"}),u=Object(o.useMemo)((()=>{var a;const o=null!==(a=null!=l?l:n)&&void 0!==a?a:null;return e.map((({key:e,docCount:a})=>{let s=a;return o&&t[o.key]&&t[o.key][e]&&(s-=t[o.key][e]),{time:e,value:s}}))}),[e,n,l,t]),d=Object(o.useMemo)((()=>{var a;const o=null!==(a=null!=l?l:n)&&void 0!==a?a:null;return null!==o?e.map((({key:e})=>({time:e,value:t&&t[o.key]&&t[o.key][e]?t[o.key][e]:0}))):void 0}),[e,n,l,t]);return void 0===(null==r?void 0:r.interval)?null:Object(f.jsx)(s.a.Fragment,null,Object(f.jsx)(z.a,{totalCount:a}),Object(f.jsx)(w.a,{chartPoints:u,chartPointsSplit:d,timeRangeEarliest:e[0].key,timeRangeLatest:e[e.length-1].key,interval:r.interval,chartPointsSplitLabel:c,isBrushCleared:!1}))},_=({eventRateLength:e,fieldSelected:t,categoriesLength:a,loading:o})=>!0===o?null:Object(f.jsx)(s.a.Fragment,null,0===e?Object(f.jsx)(l.EuiEmptyPrompt,{title:Object(f.jsx)("h2",null,Object(f.jsx)(n.FormattedMessage,{id:"xpack.aiops.logCategorization.noDocsTitle",defaultMessage:"No documents found"})),titleSize:"xs",body:Object(f.jsx)("p",null,Object(f.jsx)(n.FormattedMessage,{id:"xpack.aiops.logCategorization.noDocsBody",defaultMessage:"Ensure the selected time range contains documents."})),"data-test-subj":"aiopsNoWindowParametersEmptyPrompt"}):null,e>0&&null===a?Object(f.jsx)(l.EuiEmptyPrompt,{title:Object(f.jsx)("h2",null,Object(f.jsx)(n.FormattedMessage,{id:"xpack.aiops.logCategorization.emptyPromptTitle",defaultMessage:"Select a text field and click run categorization to start analysis"})),titleSize:"xs",body:Object(f.jsx)("p",null,Object(f.jsx)(n.FormattedMessage,{id:"xpack.aiops.logCategorization.emptyPromptBody",defaultMessage:"Log pattern analysis groups messages into common categories."})),"data-test-subj":"aiopsNoWindowParametersEmptyPrompt"}):null,e>0&&null!==a&&0===a?Object(f.jsx)(l.EuiEmptyPrompt,{title:Object(f.jsx)("h2",null,Object(f.jsx)(n.FormattedMessage,{id:"xpack.aiops.logCategorization.noCategoriesTitle",defaultMessage:"No categories found"})),titleSize:"xs",body:Object(f.jsx)("p",null,Object(f.jsx)(n.FormattedMessage,{id:"xpack.aiops.logCategorization.noCategoriesBody",defaultMessage:"Ensure the selected field is populated in the selected time range."})),"data-test-subj":"aiopsNoWindowParametersEmptyPrompt"}):null);var M={name:"1qw7xfh",styles:"min-width:410px"},P={name:"xdvdnl",styles:"margin-top:auto"},I={name:"xdvdnl",styles:"margin-top:auto"};const L=({dataView:e,savedSearch:t})=>{var a;const{notifications:{toasts:x}}=Object(j.b)(),{runCategorizeRequest:O,cancelRequest:y}=function(){const{data:e}=Object(j.b)(),t=Object(o.useRef)(new AbortController);return{runCategorizeRequest:Object(o.useCallback)(((a,o,s,i,n,l,r)=>new Promise(((c,u)=>{e.search.search(function(e,t,a,o,s,i,n){const l=Object(p.cloneDeep)(i);return void 0===l.bool&&(l.bool={}),void 0===l.bool.must&&(l.bool.must=[],void 0!==l.match_all&&(l.bool.must.push({match_all:l.match_all}),delete l.match_all)),void 0!==l.multi_match&&(l.bool.should={multi_match:l.multi_match},delete l.multi_match),l.bool.must.push({range:{[a]:{gte:o,lte:s,format:"epoch_millis"}}}),{params:{index:e,size:0,body:{query:l,aggs:{categories:{categorize_text:{field:t,size:1e3},aggs:{hit:{top_hits:{size:1,sort:[a],_source:t}},...n?{sparkline:{date_histogram:{field:a,fixed_interval:`${n}ms`}}}:{}}}}}}}}(a,o,s,i,n,l,r),{abortSignal:t.current.signal}).subscribe({next:e=>{Object(m.isCompleteResponse)(e)?c(function(e,t){const a={};if(void 0===e.rawResponse.aggregations)throw new Error("processCategoryResults failed, did not return aggregations.");return{categories:e.rawResponse.aggregations.categories.buckets.map((e=>(a[e.key]=void 0===e.sparkline?{}:e.sparkline.buckets.reduce(((e,t)=>(e[t.key]=t.doc_count,e)),{}),{key:e.key,count:e.doc_count,examples:e.hit.hits.hits.map((e=>Object(p.get)(e._source,t)))}))),sparkLinesPerCategory:a}}(e,o)):Object(m.isErrorResponse)(e)&&u(e)},error:e=>{if("AbortError"===e.name)return c({categories:[],sparkLinesPerCategory:{}});u(e)}})}))),[e.search]),cancelRequest:Object(o.useCallback)((()=>{t.current.abort(),t.current=new AbortController}),[])}}(),[h,v]=Object(o.useState)(b.b),[C,k]=Object(g.d)("_g"),[S,w]=Object(o.useState)(),[z,L]=Object(o.useState)(null),[R,D]=Object(o.useState)(null),[B,T]=Object(o.useState)(t),[q,N]=Object(o.useState)(!1),[V,Q]=Object(o.useState)(0),[A,G]=Object(o.useState)([]),[W,H]=Object(o.useState)(null),[$,J]=Object(o.useState)({});Object(o.useEffect)((function(){return()=>{y()}}),[y]);const U=Object(o.useCallback)((e=>{null!==B&&T(null),v({...h,searchQuery:e.searchQuery,searchString:e.searchString,searchQueryLanguage:e.queryLanguage,filters:e.filters})}),[B,h,v]),{documentStats:K,timefilter:X,earliest:Y,latest:Z,searchQueryLanguage:ee,searchString:te,searchQuery:ae,intervalMs:oe}=Object(u.a)({currentDataView:e,currentSavedSearch:B},h,k,void 0,void 0,20);Object(o.useEffect)((()=>{void 0!==(null==C?void 0:C.time)&&X.setTime({from:C.time.from,to:C.time.to})}),[JSON.stringify(null==C?void 0:C.time),X]);const se=Object(o.useMemo)((()=>e.fields.filter((({displayName:e,esTypes:t,count:a})=>t&&t.includes("text")&&!["_id","_index"].includes(e))).map((({displayName:e})=>({label:e})))),[e]);Object(o.useEffect)((function(){1===se.length&&w(se[0].label)}),[se]),Object(o.useEffect)((()=>{var e;null!==(e=K.documentCountStats)&&void 0!==e&&e.buckets&&(G(Object.entries(K.documentCountStats.buckets).map((([e,t])=>({key:+e,docCount:t})))),D(null),Q(K.totalCount))}),[K,Y,Z,ee,te,ae]);const ie=Object(o.useCallback)((async()=>{N(!0),D(null);const{title:t,timeFieldName:a}=e;if(void 0!==S&&void 0!==a){y();try{const e=await O(t,S,a,Y,Z,ae,oe);D(e.categories),J(e.sparkLinesPerCategory)}catch(e){x.addError(e,{title:i.i18n.translate("xpack.aiops.logCategorization.errorLoadingCategories",{defaultMessage:"Error loading categories"})})}N(!1)}}),[S,e,ae,Y,Z,O,y,oe,x]);return Object(f.jsx)(l.EuiPageBody,{"data-test-subj":"aiopsExplainLogRateSpikesPage",paddingSize:"none",panelled:!1},Object(f.jsx)(l.EuiFlexGroup,{gutterSize:"none"},Object(f.jsx)(l.EuiFlexItem,null,Object(f.jsx)(l.EuiPageContentHeader_Deprecated,{className:"aiopsPageHeader"},Object(f.jsx)(l.EuiPageContentHeaderSection_Deprecated,null,Object(f.jsx)("div",{className:"dataViewTitleHeader"},Object(f.jsx)(l.EuiTitle,{size:"s"},Object(f.jsx)("h2",null,e.getName())))),Object(f.jsx)(l.EuiFlexGroup,{alignItems:"center",justifyContent:"flexEnd",gutterSize:"s","data-test-subj":"aiopsTimeRangeSelectorSection"},void 0!==e.timeFieldName&&Object(f.jsx)(l.EuiFlexItem,{grow:!1},Object(f.jsx)(r.a,{dataView:e,query:void 0,disabled:!1,timefilter:X})),Object(f.jsx)(l.EuiFlexItem,{grow:!1},Object(f.jsx)(c.a,null)))))),Object(f.jsx)(l.EuiSpacer,null),Object(f.jsx)(l.EuiFlexGroup,{gutterSize:"none"},Object(f.jsx)(l.EuiFlexItem,null,Object(f.jsx)(d.a,{dataView:e,searchString:null!=te?te:"",searchQuery:ae,searchQueryLanguage:ee,setSearchParams:U}))),Object(f.jsx)(l.EuiSpacer,{size:"m"}),Object(f.jsx)(l.EuiFlexGroup,{gutterSize:"none"},Object(f.jsx)(l.EuiFlexItem,{grow:!1,css:M},Object(f.jsx)(l.EuiFormRow,{label:i.i18n.translate("xpack.aiops.logCategorization.categoryFieldSelect",{defaultMessage:"Category field"})},Object(f.jsx)(l.EuiComboBox,{isDisabled:!0===q,options:se,onChange:e=>{D(null),w(e&&e.length?e[0].label:void 0)},selectedOptions:void 0===S?void 0:[{label:S}],singleSelection:{asPlainText:!0}}))),Object(f.jsx)(l.EuiFlexItem,{grow:!1,css:P},!1===q?Object(f.jsx)(l.EuiButton,{disabled:void 0===S,onClick:()=>{ie()}},Object(f.jsx)(n.FormattedMessage,{id:"xpack.aiops.logCategorization.runButton",defaultMessage:"Run categorization"})):Object(f.jsx)(l.EuiButton,{onClick:()=>y()},"Cancel")),Object(f.jsx)(l.EuiFlexItem,{grow:!1,css:I}),Object(f.jsx)(l.EuiFlexItem,null)),A.length?Object(f.jsx)(s.a.Fragment,null,Object(f.jsx)(l.EuiSpacer,null),Object(f.jsx)(F,{eventRate:A,pinnedCategory:W,selectedCategory:z,sparkLines:$,totalCount:V,documentCountStats:K.documentCountStats}),Object(f.jsx)(l.EuiSpacer,null)):null,!0===q?Object(f.jsx)(l.EuiLoadingContent,{lines:10}):null,Object(f.jsx)(_,{loading:q,categoriesLength:null!==(a=null==R?void 0:R.length)&&void 0!==a?a:null,eventRateLength:A.length,fieldSelected:null!==S}),void 0!==S&&null!==R&&R.length>0?Object(f.jsx)(E,{categories:R,aiopsListState:h,dataViewId:e.id,eventRate:A,sparkLines:$,selectedField:S,pinnedCategory:W,setPinnedCategory:H,selectedCategory:z,setSelectedCategory:L,timefilter:X}):null)};t.default=({dataView:e,savedSearch:t,appDependencies:a})=>Object(f.jsx)(j.a.Provider,{value:a},Object(f.jsx)(g.b,null,Object(f.jsx)(L,{dataView:e,savedSearch:t})))}}]);