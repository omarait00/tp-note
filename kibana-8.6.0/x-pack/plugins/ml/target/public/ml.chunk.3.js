/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements. 
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[3],{101:function(e,t,n){"use strict";n.d(t,"j",(function(){return f})),n.d(t,"g",(function(){return b})),n.d(t,"h",(function(){return _})),n.d(t,"f",(function(){return m})),n.d(t,"k",(function(){return E})),n.d(t,"n",(function(){return g})),n.d(t,"e",(function(){return p})),n.d(t,"d",(function(){return T})),n.d(t,"l",(function(){return O})),n.d(t,"m",(function(){return h})),n.d(t,"a",(function(){return v})),n.d(t,"b",(function(){return C})),n.d(t,"i",(function(){return I})),n.d(t,"c",(function(){return N}));var a=n(2),r=n(47),i=n(112),o=n(103),s=n(138),l=n(0),c=n(127),d=n(93),u=n(91);function f(e,t,n,a=!1){const r=a?function(e,t){return y(e.analysis_config.detectors)}(e):function(e,t){let n=e.analysis_config.detectors;const a=E(e,t);if(void 0!==t.aggregations&&e.analysis_config.detectors[0].function===o.b.NON_ZERO_COUNT&&!1===a){var r,i,s,l,d;const e=null==t||null===(r=t.aggregations)||void 0===r||null===(i=r.buckets)||void 0===i||null===(s=i.aggregations)||void 0===s||null===(l=s.dc_region)||void 0===l||null===(d=l.cardinality)||void 0===d?void 0:d.field;void 0!==e&&(n=[{function:o.b.DISTINCT_COUNT,field_name:e}])}else n=y(n),n=n.map((e=>{switch(e.function){case o.b.NON_ZERO_COUNT:return{...e,field_name:c.a,function:o.b.COUNT};case o.b.HIGH_NON_ZERO_COUNT:return{...e,field_name:c.a,function:o.b.HIGH_COUNT};case o.b.LOW_NON_ZERO_COUNT:return{...e,field_name:c.a,function:o.b.LOW_COUNT};case o.b.NON_NULL_SUM:return{...e,function:o.b.SUM};case o.b.HIGH_NON_NULL_SUM:return{...e,function:o.b.HIGH_SUM};case o.b.LOW_NON_NULL_SUM:return{...e,function:o.b.LOW_SUM};default:return e}}));return n}(e,t),l=(e=>t=>{let n=i.a.getFieldById(t);return null===n&&(t===s.b?n=c.c:e.length&&(n=e.find((e=>e.id===t))||null)),n})(n);return r.map((e=>{var t,n,a;let r=null,o=null,s=null,c=null;return void 0!==e.field_name&&(r=l(e.field_name)),void 0!==e.by_field_name&&(o=l(e.by_field_name)),void 0!==e.over_field_name&&(s=l(e.over_field_name)),void 0!==e.partition_field_name&&(c=l(e.partition_field_name)),{agg:i.a.getAggById(e.function),field:r,byField:o,overField:s,partitionField:c,excludeFrequent:null!==(t=e.exclude_frequent)&&void 0!==t?t:null,description:null!==(n=e.detector_description)&&void 0!==n?n:null,useNull:null!==(a=e.use_null)&&void 0!==a?a:null}}))}function b(e,t){return[...e.filter((e=>e.id!==c.a)).map((e=>({label:e.name}))),...t.filter((t=>!1===e.some((e=>e.id===t.id)))).map((e=>({label:e.id})))].sort(((e,t)=>e.label.localeCompare(t.label)))}function _(e){return null===e?[]:[{label:s.b}]}function m(e){return e?[{label:s.a}]:[{label:s.d}]}function y(e){return e.map((e=>{switch(e.function){case o.b.COUNT:case o.b.HIGH_COUNT:case o.b.LOW_COUNT:case o.b.NON_ZERO_COUNT:case o.b.HIGH_NON_ZERO_COUNT:case o.b.LOW_NON_ZERO_COUNT:case o.b.RARE:case o.b.FREQ_RARE:case o.b.TIME_OF_DAY:case o.b.TIME_OF_WEEK:return{...e,field_name:c.a};default:return e}}))}function E(e,t){var n,a,r,i,s;const l=e.analysis_config.detectors;if(void 0===(null==t||null===(n=t.aggregations)||void 0===n||null===(a=n.buckets)||void 0===a||null===(r=a.aggregations)||void 0===r||null===(i=r.dc_region)||void 0===i||null===(s=i.cardinality)||void 0===s?void 0:s.field))for(const e of l)if(o.c.includes(e.function))return!0;return!1}function g(e,t=!1,n=!1,a=!1){var r;d.a.tempJobCloningObjects.job=e.jobConfig,d.a.tempJobCloningObjects.datafeed=e.datafeedConfig,d.a.tempJobCloningObjects.createdBy=null!==(r=e.createdBy)&&void 0!==r?r:void 0,d.a.tempJobCloningObjects.skipTimeRangeStep=t,!0===n&&!1===a?(d.a.tempJobCloningObjects.start=e.start,d.a.tempJobCloningObjects.end=e.end):!0===a&&(d.a.tempJobCloningObjects.autoSetTimeRange=!0),d.a.tempJobCloningObjects.calendars=e.calendars}function p(e,t){e.createdBy=u.a.MULTI_METRIC,e.modelPlot=!1,g(e,!0,!0),t(l.b.ANOMALY_DETECTION_CREATE_JOB_CONVERT_TO_MULTI_METRIC,!0)}function T(e,t){e.createdBy=null,g(e,!0,!0),t(l.b.ANOMALY_DETECTION_CREATE_JOB_CONVERT_TO_ADVANCED,!0)}function O(e,t){e.createdBy=null,g(e,!0,!1),t(l.b.ANOMALY_DETECTION_CREATE_JOB)}function h(e,t){e.jobId="",g(e,!0,!0),t(l.b.ANOMALY_DETECTION_CREATE_JOB)}function v(e,t){null!==e&&g(e,!1,!1),t("/jobs")}function C(e){return!1===e.some((e=>null===e.agg.dslName))}function I(e){switch(e.type){case u.f.SINGLE_METRIC:return a.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.singleMetric",{defaultMessage:"Single metric"});case u.f.MULTI_METRIC:return a.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.multiMetric",{defaultMessage:"Multi-metric"});case u.f.POPULATION:return a.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.population",{defaultMessage:"Population"});case u.f.ADVANCED:return a.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.advanced",{defaultMessage:"Advanced"});case u.f.CATEGORIZATION:return a.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.categorization",{defaultMessage:"Categorization"});case u.f.RARE:return a.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.rare",{defaultMessage:"Rare"});default:return""}}function N(e,t){for(const n in e)null!==e[n]&&"object"==typeof e[n]&&("aggregations"!==n&&"aggs"!==n||Object.keys(e[n]).forEach((e=>{"aggregations"!==e&&"aggs"!==e&&t.push({id:e,name:e,type:r.ES_FIELD_TYPES.KEYWORD,aggregatable:!0})})),N(e[n],t))}},112:function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var a=n(5),r=n.n(a),i=n(47),o=n(127),s=n(134),l=n(81),c=n(219);class NewJobCapsService extends c.a{constructor(...e){super(...e),r()(this,"_catFields",[]),r()(this,"_dateFields",[]),r()(this,"_includeEventRateField",!0),r()(this,"_removeTextFields",!0)}get catFields(){return this._catFields}get dateFields(){return this._dateFields}get categoryFields(){return Object(s.b)(this._fields)}async initializeFromDataVIew(e,t=!0,n=!0){try{this._includeEventRateField=t,this._removeTextFields=n;const a=await l.ml.jobs.newJobCaps(e.title,"rollup"===e.type),{fields:r,aggs:s}=function(e,t){const n=e[t],a=[],r=[],i={},o={};return void 0!==n&&(n.aggs.forEach((e=>{const t={...e,...void 0!==e.fieldIds?{fields:[]}:{}};i[t.id]=t,r.push(t)})),n.fields.forEach((e=>{const t={...e,aggs:[]};void 0!==t.aggIds&&(o[t.id]=t.aggIds),a.push(t)})),a.forEach((e=>{o[e.id].forEach((t=>{!function(e,t){void 0===t.fields&&(t.fields=[]),void 0===e.aggs&&(e.aggs=[]),t.fields.push(e),e.aggs.push(t)}(e,i[t])}))}))),a.forEach((e=>delete e.aggIds)),r.forEach((e=>delete e.fieldIds)),{fields:a,aggs:r}}(a,e.title);!0===this._includeEventRateField&&function(e,t){const n={id:o.a,name:"Event rate",type:i.ES_FIELD_TYPES.INTEGER,aggregatable:!0,aggs:[]};e.forEach((e=>{void 0!==n.aggs&&void 0===e.fields&&(e.fields=[n],n.aggs.push(e))})),t.splice(0,0,n)}(s,r);const{fieldsPreferringKeyword:d,fieldsPreferringText:u}=Object(c.b)(r),f=u.filter((e=>e.type===i.ES_FIELD_TYPES.KEYWORD||e.type===i.ES_FIELD_TYPES.TEXT)),b=u.filter((e=>e.type===i.ES_FIELD_TYPES.DATE)),_=this._removeTextFields?d:r;this._fields=_,this._catFields=f,this._dateFields=b,this._aggs=s}catch(e){console.error("Unable to load new job capabilities",e)}}}const d=new NewJobCapsService},134:function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"c",(function(){return c})),n.d(t,"b",(function(){return d}));var a=n(32),r=n(127),i=n(103);const o=[a.ES_FIELD_TYPES.TEXT,a.ES_FIELD_TYPES.KEYWORD,a.ES_FIELD_TYPES.IP,a.ES_FIELD_TYPES.VERSION];function s(e,t,n){const o=function(e){return e.filter((e=>e.type===a.ES_FIELD_TYPES.KEYWORD||e.type===a.ES_FIELD_TYPES.VERSION))}(e),s=function(e){return e.filter((e=>e.type===a.ES_FIELD_TYPES.TEXT))}(e),c=function(e){return e.filter((e=>e.type===a.ES_FIELD_TYPES.LONG||e.type===a.ES_FIELD_TYPES.UNSIGNED_LONG||e.type===a.ES_FIELD_TYPES.INTEGER||e.type===a.ES_FIELD_TYPES.SHORT||e.type===a.ES_FIELD_TYPES.BYTE||e.type===a.ES_FIELD_TYPES.DOUBLE||e.type===a.ES_FIELD_TYPES.FLOAT||e.type===a.ES_FIELD_TYPES.HALF_FLOAT||e.type===a.ES_FIELD_TYPES.SCALED_FLOAT))}(e),d=function(e){return e.filter((e=>e.type===a.ES_FIELD_TYPES.IP))}(e),u=function(e){return e.filter((e=>e.type===a.ES_FIELD_TYPES.GEO_POINT||e.type===a.ES_FIELD_TYPES.GEO_SHAPE))}(e),f=Object.keys(n).length>0,b=function(e,t){return function(n,a){(!1===e||t[n.id]&&t[n.id].find((e=>e.agg===a.dslName)))&&(void 0!==n.aggs&&n.aggs.push(a),void 0!==a.fields&&a.fields.push(n))}}(f,n);return t.forEach((e=>{if(e.type===r.b&&void 0!==e.fields)switch(e.id){case i.b.LAT_LONG:u.forEach((t=>b(t,e)));break;case i.b.INFO_CONTENT:case i.b.HIGH_INFO_CONTENT:case i.b.LOW_INFO_CONTENT:s.forEach((t=>b(t,e)));case i.b.DISTINCT_COUNT:case i.b.HIGH_DISTINCT_COUNT:case i.b.LOW_DISTINCT_COUNT:o.forEach((t=>b(t,e))),d.forEach((t=>b(t,e)));default:c.forEach((t=>{b(t,e)}))}})),{aggs:t,fields:f?l(e):e}}function l(e){return e.filter((e=>e.aggs&&(e.aggs.length>0||0===e.aggs.length&&e.type===a.ES_FIELD_TYPES.DATE)))}function c(e){if(0===e.length)return e;let t;return e[0].id===r.a&&([t]=e.splice(0,1)),e.sort(((e,t)=>e.name.localeCompare(t.name))),void 0!==t&&e.splice(0,0,t),e}function d(e,t=!0){return e.filter((e=>o.includes(e.type)===t))}},145:function(e,t,n){"use strict";n.d(t,"c",(function(){return i})),n.d(t,"b",(function(){return o})),n.d(t,"a",(function(){return s}));var a=n(127),r=n(88);function i(){return{job_id:"",description:"",groups:[],analysis_config:{bucket_span:"",detectors:[],influencers:[]},data_description:{time_field:""}}}function o(e){return{datafeed_id:"",job_id:"",indices:Object(r.u)(e),query:{}}}function s(e,t){const n={function:e.id};return t.id!==a.a&&(n.field_name=t.id),n}},189:function(e,t,n){"use strict";n.d(t,"c",(function(){return d})),n.d(t,"d",(function(){return u})),n.d(t,"b",(function(){return f})),n.d(t,"a",(function(){return b}));var a=n(8),r=n(51),i=n(47),o=n(110),s=n(104);const l={bool:{must:[{match_all:{}}]}},c={query:"",language:"lucene"};function d(){return Object(a.cloneDeep)(l)}function u(){return Object(a.cloneDeep)(c)}function f(e,t,n){return null===n?{query:u(),combinedQuery:d()}:b(Object(s.f)(n),t,e)}function b(e,t,n){let a=u(),s=d();a=e.query;const l=e.filter,c=Array.isArray(l)?l:[];if(a.language===o.c.KUERY){const e=Object(r.fromKueryExpression)(a.query);""!==a.query&&(s=Object(r.toElasticsearchQuery)(e,t));const n=Object(r.buildQueryFromFilters)(c,t);void 0===s.bool&&(s.bool={},void 0!==s.multi_match&&(s.bool.should={multi_match:s.multi_match},delete s.multi_match)),!1===Array.isArray(s.bool.filter)&&(s.bool.filter=void 0===s.bool.filter?[]:[s.bool.filter]),!1===Array.isArray(s.bool.must_not)&&(s.bool.must_not=void 0===s.bool.must_not?[]:[s.bool.must_not]),s.bool.filter=[...s.bool.filter,...n.filter],s.bool.must_not=[...s.bool.must_not,...n.must_not]}else{const e=Object(i.getEsQueryConfig)(n);s=Object(r.buildEsQuery)(t,[a],c,e)}return{query:a,combinedQuery:s}}},262:function(e,t,n){"use strict";n.r(t),n.d(t,"VisualizationExtractor",(function(){return visualization_extractor_VisualizationExtractor})),n.d(t,"resolver",(function(){return w})),n.d(t,"QuickJobCreator",(function(){return quick_create_job_QuickJobCreator})),n.d(t,"getJobsItemsFromEmbeddable",(function(){return b})),n.d(t,"isCompatibleVisualizationType",(function(){return m})),n.d(t,"redirectToADJobWizards",(function(){return f}));var a=n(69),r=n(2),i=n(91),o=n(47),s=n(0),l=n(103);const c=["line","bar","bar_stacked","bar_percentage_stacked","bar_horizontal","bar_horizontal_stacked","area","area_stacked","area_percentage_stacked"],d=a.layerTypes.DATA,u=[o.KBN_FIELD_TYPES.STRING,o.KBN_FIELD_TYPES.IP];async function f(e,t,n){const{query:a,filters:r,to:i,from:o,vis:l}=b(e),c=n.url.locators.get(s.a),d=await(null==c?void 0:c.getUrl({page:s.b.ANOMALY_DETECTION_CREATE_JOB_FROM_LENS,pageState:{vis:l,from:o,to:i,query:a,filters:r,layerIndex:t}}));window.open(d,"_blank")}function b(e){var t;const{filters:n,timeRange:a,...i}=e.getInput(),o=void 0===i.query?{query:"",language:"kuery"}:i.query;if(void 0===a)throw Error(r.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.noTimeRange",{defaultMessage:"Time range not specified."}));const{to:s,from:l}=a,c=e.getSavedVis();if(void 0===c)throw Error(r.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.visNotFound",{defaultMessage:"Visualization cannot be found."}));return{vis:c,from:l,to:s,query:o,filters:n,dashboard:"dashboard"===(null===(t=e.parent)||void 0===t?void 0:t.type)?e.parent:void 0}}function _(e){const t=function(e){switch(e){case"average":return l.b.MEAN;case"count":return l.b.COUNT;case"max":return l.b.MAX;case"median":return l.b.MEDIAN;case"min":return l.b.MIN;case"sum":return l.b.SUM;case"unique_count":return l.b.DISTINCT_COUNT;default:return null}}(e);if(null===t)throw Error(r.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.incorrectFunction",{defaultMessage:"Selected function {operationType} is not supported by anomaly detection detectors",values:{operationType:e}}));return t}async function m(e){const t=e.state.visualization;return"lnsXY"===e.visualizationType&&t.layers.some((e=>e.layerType===a.layerTypes.DATA))}function y(e){return function(e){return"seriesType"in e}(e)&&e.layerType===d&&c.includes(e.seriesType)}function E(e,t){return e.map((({operationType:e,sourceField:n})=>{const a=_(e);return{function:a,..."count"===a?{}:{field_name:n},...t?{partition_field_name:t.sourceField}:{}}}))}class visualization_extractor_VisualizationExtractor{constructor(e){this.dataViewClient=e}async getResultLayersFromEmbeddable(e,t){const{vis:n}=b(e);return this.getLayers(n,t)}async extractFields(e,t){var n;if(!y(e))throw Error(r.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.incompatibleLayerType",{defaultMessage:"Layer is incompatible. Only chart layers can be used."}));const a=t.state.datasourceStates.formBased,i=Object.entries(a.layers).find((([t])=>e.layerId===t));if(void 0===i)throw Error(r.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.noCompatibleLayers",{defaultMessage:"Visualization does not contain any layers which can be used for creating an anomaly detection job."}));const[o,s]=i,l=function({columns:e},t){if(t.accessors.forEach((t=>{const n=e[t];return"date"!==n.dataType&&_(n.operationType)})),Object.values(e).some((e=>0=="sourceField"in e)))throw Error(r.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.colsNoSourceField",{defaultMessage:"Some columns do not contain a source field."}));if(Object.values(e).some((e=>{return 1==("timeShift"in(t=e)||"filter"in t);var t})))throw Error(r.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.colsUsingFilterTimeSift",{defaultMessage:"Columns contain settings which are incompatible with ML detectors, time shift and filter by are not supported."}));return e}(s,e),c=Object.values(l).find((({dataType:e})=>"date"===e));if(void 0===c)throw Error(r.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.noDateField",{defaultMessage:"Cannot find a date field."}));const d=e.accessors.map((e=>l[e])),f=e.splitAccessor?l[e.splitAccessor]:null;if(null!==f&&"terms"===(b=f).operationType&&"params"in b&&null!==(n=f.params.secondaryFields)&&void 0!==n&&n.length)throw Error(r.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.splitFieldHasMultipleFields",{defaultMessage:"Selected split field contains more than one field."}));var b;if(null!==f&&!1===function(e){return u.includes(e.dataType)}(f))throw Error(r.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.splitFieldMustBeString",{defaultMessage:"Selected split field type must be string."}));const m=await this.getDataViewFromLens(t.references,o);if(null===m)throw Error(r.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.noDataViews",{defaultMessage:"No data views can be found in the visualization."}));if(c.sourceField!==m.timeFieldName)throw Error(r.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.timeFieldNotInDataView",{defaultMessage:"Selected time field must be the default time field configured for data view."}));return{fields:d,timeField:c,splitField:f,dataView:m}}async getLayers(e,t){const n=e.state.visualization,o=await async function(e){const t=await e.getXyVisTypes();return e=>{var n;switch(e.layerType){case a.layerTypes.DATA:const i=t.find((t=>t.id===e.seriesType));return{label:(null==i?void 0:i.fullLabel)||(null==i?void 0:i.label)||e.layerType,icon:null!==(n=null==i?void 0:i.icon)&&void 0!==n?n:""};case a.layerTypes.ANNOTATIONS:return{label:r.i18n.translate("xpack.ml.newJob.fromLens.createJob.VisType.annotations",{defaultMessage:"Annotations"}),icon:""};case a.layerTypes.REFERENCELINE:return{label:r.i18n.translate("xpack.ml.newJob.fromLens.createJob.VisType.referenceLine",{defaultMessage:"Reference line"}),icon:""};default:return{label:e.layerType,icon:""}}}}(t);return await Promise.all(n.layers.filter((({layerType:e})=>e===a.layerTypes.DATA)).map((async t=>{const{icon:n,label:a}=o(t);try{const{fields:r,splitField:o}=await this.extractFields(t,e),s=E(r,o),l=o||s.length>1?i.f.MULTI_METRIC:i.f.SINGLE_METRIC;return{id:t.layerId,layerType:t.layerType,label:a,icon:n,jobType:l,isCompatible:!0}}catch(e){return{id:t.layerId,layerType:t.layerType,label:a,icon:n,jobType:null,isCompatible:!1,error:e}}})))}async getDataViewFromLens(e,t){const n=e.find((e=>"index-pattern"===e.type&&e.name===`indexpattern-datasource-layer-${t}`));return n?this.dataViewClient.get(n.id):null}}var g=n(59),p=n.n(g),T=n(8),O=n(23),h=n(51),v=n(145),C=n(101),I=n(88),N=n(189);class quick_create_job_QuickJobCreator{constructor(e,t,n,a,r){this.dataViewClient=e,this.kibanaConfig=t,this.timeFilter=n,this.share=a,this.mlApiServices=r}async createAndSaveJob(e,t,n,a,r,o){const{query:s,filters:l,to:c,from:d,vis:u,dashboard:f}=b(n);if(void 0===s||void 0===l)throw new Error("Cannot create job, query and filters are undefined");const{jobConfig:_,datafeedConfig:m,start:y,end:E,jobType:g}=await this.createJob(u,d,c,s,l,t,o),p=Object(I.g)(e),T={...m,job_id:e,datafeed_id:p},h={..._,job_id:e,custom_settings:{created_by:g===i.f.SINGLE_METRIC?i.a.SINGLE_METRIC_FROM_LENS:i.a.MULTI_METRIC_FROM_LENS,...await this.getCustomUrls(f,T)}},v={jobCreated:{success:!1},datafeedCreated:{success:!1},jobOpened:{success:!1},datafeedStarted:{success:!1}};try{if(void 0!==y&&void 0!==E&&void 0!==h.data_description.time_field&&m.indices.length>0){const{modelMemoryLimit:e}=await Object(O.firstValueFrom)(this.mlApiServices.calculateModelMemoryLimit$({datafeedConfig:T,analysisConfig:h.analysis_config,indexPattern:m.indices[0],query:m.query,timeFieldName:h.data_description.time_field,earliestMs:y,latestMs:E}));void 0===h.analysis_limits&&(h.analysis_limits={}),h.analysis_limits.model_memory_limit=e}}catch(e){console.error("could not calculate model memory limit",e)}try{await this.mlApiServices.addJob({jobId:h.job_id,job:h})}catch(e){return v.jobCreated.error=e,v}v.jobCreated.success=!0;try{await this.mlApiServices.addDatafeed({datafeedId:p,datafeedConfig:T})}catch(e){return v.datafeedCreated.error=e,v}if(v.datafeedCreated.success=!0,a){try{await this.mlApiServices.openJob({jobId:e})}catch(e){if(409!==e.body.statusCode)return v.jobOpened.error=e,v}v.jobOpened.success=!0;try{await this.mlApiServices.startDatafeed({datafeedId:p,start:y,...r?{}:{end:E}})}catch(e){return v.datafeedStarted.error=e,v}v.datafeedStarted.success=!0}return v}async createAndStashADJob(e,t,n,a,r,o){try{const{jobConfig:s,datafeedConfig:l,jobType:c,start:d,end:u,includeTimeRange:f}=await this.createJob(e,t,n,a,r,i.b,o);Object(C.n)({jobConfig:s,datafeedConfig:l,createdBy:c===i.f.SINGLE_METRIC?i.a.SINGLE_METRIC:i.a.MULTI_METRIC,start:d,end:u},!0,f,!f)}catch(e){console.error(e)}}async createJob(e,t,n,a,i,o,s){const{jobConfig:l,datafeedConfig:c,jobType:d}=await this.createADJobFromLensSavedObject(e,a,i,o,s);let u,f,b=!0;try{const{min:e,max:a}=this.timeFilter.calculateBounds({to:n,from:t});if(u=null==e?void 0:e.valueOf(),f=null==a?void 0:a.valueOf(),void 0===u||void 0===f||isNaN(u)||isNaN(f))throw Error(r.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.timeRange",{defaultMessage:"Incompatible time range"}))}catch(e){console.error(e),b=!1,u=void 0,f=void 0}return{jobConfig:l,datafeedConfig:c,jobType:d,start:u,end:f,includeTimeRange:b}}async createADJobFromLensSavedObject(e,t,n,a,r){const o=e.state.visualization,s=o.layers.filter(y),l=void 0!==r?o.layers[r]:s[0],c=new visualization_extractor_VisualizationExtractor(this.dataViewClient),{fields:d,timeField:u,splitField:f,dataView:b}=await c.extractFields(l,e),_=Object(v.c)(),m=Object(v.b)(b.title),g=this.combineQueriesAndFilters({query:t,filters:n},{query:e.state.query,filters:e.state.filters},b);m.query=g,_.analysis_config.detectors=E(d,f),_.data_description.time_field=u.sourceField,_.analysis_config.bucket_span=a,f&&(_.analysis_config.influencers=[f.sourceField]);const p=null===f&&1===_.analysis_config.detectors.length,T=p?i.f.SINGLE_METRIC:i.f.MULTI_METRIC;return p&&(_.model_plot_config={enabled:!0,annotations_enabled:!0}),{jobConfig:_,datafeedConfig:m,jobType:T}}combineQueriesAndFilters(e,t,n){const{combinedQuery:a}=Object(N.a)({query:e.query,filter:e.filters},n,this.kibanaConfig),{combinedQuery:r}=Object(N.a)({query:t.query,filter:t.filters},n,this.kibanaConfig);return Object(T.mergeWith)(a,r,((e,t)=>{if(Array.isArray(e)){const n=e.concat(t);return Object(T.uniqBy)(n,T.isEqual)}}))}async createDashboardLink(e,t){if(void 0===e)return null;const n={dashboardId:e.id,timeRange:{from:"$earliest$",to:"$latest$",mode:"absolute"},filters:Object(I.h)(t.query,void 0,t.job_id,h.FilterStateStore.GLOBAL_STATE)},a=this.share.url.locators.get("DASHBOARD_APP_LOCATOR"),i=a?await a.getUrl(n):"",o=decodeURIComponent(i).replace(/^.+dashboards/,"dashboards"),s=e.getOutput().title;return{url_name:void 0===s?r.i18n.translate("xpack.ml.newJob.fromLens.createJob.defaultUrlDashboard",{defaultMessage:"Original dashboard"}):r.i18n.translate("xpack.ml.newJob.fromLens.createJob.namedUrlDashboard",{defaultMessage:"Open {dashboardName}",values:{dashboardName:s}}),url_value:o,time_range:"auto"}}async getCustomUrls(e,t){return void 0!==e?{custom_urls:[await this.createDashboardLink(e,t)]}:{}}}var S=n(81),L=n(27);async function w(e,t,n,a,r,i,o){let s,l,c,d,u,f;if(e)s=await async function(e){const t=Object(L.j)();return(await t.get("lens",e)).attributes}(e);else{if(!t)throw new Error("Cannot create visualization");s=p.a.decode(t)}try{l=p.a.decode(r)}catch(e){l=Object(N.d)()}try{c=p.a.decode(i)}catch(e){c=[]}try{d=p.a.decode(n)}catch(e){d=""}try{u=p.a.decode(a)}catch(e){u=""}try{f=p.a.decode(o)}catch(e){f=void 0}const b=new quick_create_job_QuickJobCreator(Object(L.d)(),Object(L.o)(),Object(L.m)(),Object(L.k)(),S.ml);await b.createAndStashADJob(s,d,u,l,c,f)}}}]);