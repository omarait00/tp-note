/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements. 
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[29],{644:function(e,t,a){"use strict";a.r(t),a.d(t,"showLensVisToADJobFlyout",(function(){return T}));var s=a(17),l=a.n(s),r=a(25),o=a(23),n=a(46),i=a(211),c=a(13),b=a(45),u=a(44),d=a(2),j=a(166),x=a.n(j),m=a(262),O=a(91),E=a(26),g=a(88),p=a(29),y=a(146),S=a(0);const F=()=>Object(n.useKibana)();var L;!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.VALIDATING=1]="VALIDATING",e[e.SAVING=2]="SAVING",e[e.SAVE_SUCCESS=3]="SAVE_SUCCESS",e[e.SAVE_FAILED=4]="SAVE_FAILED"}(L||(L={}));const I=({layer:e,layerIndex:t,embeddable:a})=>{const{services:{data:r,share:o,application:n,uiSettings:i,mlServices:{mlApiServices:j}}}=F(),[E,I]=Object(s.useState)(void 0),[f,h]=Object(s.useState)(!0),[M,T]=Object(s.useState)(!0),[k,A]=Object(s.useState)(O.b),[w,_]=Object(s.useState)(""),[v,z]=Object(s.useState)(""),[J,V]=Object(s.useState)(L.DEFAULT),[D,G]=Object(s.useState)(null),B=Object(s.useMemo)((()=>new m.QuickJobCreator(r.dataViews,i,r.query.timefilter.timefilter,o,j)),[r,i]),N=Object(s.useCallback)((async e=>{const{timeRange:t}=a.getInput(),s=o.url.locators.get(S.a);if(s){const a=f?e===O.f.MULTI_METRIC?S.b.ANOMALY_EXPLORER:S.b.SINGLE_METRIC_VIEWER:S.b.ANOMALY_DETECTION_JOBS_MANAGE,l=f?{jobIds:[E],timeRange:t}:{jobId:E},r=await s.getUrl({page:a,pageState:l});n.navigateToUrl(r)}}),[E,a,o,n,f]);return x()((function(){if(void 0===E)return;_(""),z("");const e=Object(g.e)({job_id:E,analysis_config:{detectors:[],bucket_span:k}},void 0,{max_model_memory_limit:"",effective_max_model_memory_limit:""},!0);e.contains("job_id_invalid")?_(d.i18n.translate("xpack.ml.newJob.wizard.validateJob.jobNameAllowedCharactersDescription",{defaultMessage:"Job ID can contain lowercase alphanumeric (a-z and 0-9), hyphens or underscores; must start and end with an alphanumeric character"})):e.contains("job_id_invalid_max_length")?_(d.i18n.translate("xpack.ml.newJob.wizard.validateJob.jobIdInvalidMaxLengthErrorMessage",{defaultMessage:"Job ID must be no more than {maxLength, plural, one {# character} other {# characters}} long.",values:{maxLength:p.b}})):j.jobs.jobsExist([E]).then((e=>{e[E].exists&&_(d.i18n.translate("xpack.ml.newJob.wizard.validateJob.jobNameAlreadyExists",{defaultMessage:"Job ID already exists. A job ID cannot be the same as an existing job or group."}))})).catch((e=>{console.error("Could not validate whether job ID exists")})),e.contains("bucket_span_invalid")&&z(Object(y.a)(k)),V(L.DEFAULT)}),500,[E,k]),Object(c.jsx)(l.a.Fragment,null,J!==L.SAVE_SUCCESS&&J!==L.SAVING?Object(c.jsx)(l.a.Fragment,null,Object(c.jsx)(u.EuiFlexGroup,{gutterSize:"s","data-test-subj":"mlLensLayerCompatible"},Object(c.jsx)(u.EuiFlexItem,{grow:!1},Object(c.jsx)(u.EuiText,{size:"s"},Object(c.jsx)(u.EuiIcon,{type:"checkInCircleFilled",color:"success"}))),Object(c.jsx)(u.EuiFlexItem,null,Object(c.jsx)(u.EuiText,{size:"s"},e.jobType===O.f.MULTI_METRIC?Object(c.jsx)(b.FormattedMessage,{id:"xpack.ml.embeddables.lensLayerFlyout.createJobCalloutTitle.multiMetric",defaultMessage:"This layer can be used to create a multi-metric job"}):Object(c.jsx)(b.FormattedMessage,{id:"xpack.ml.embeddables.lensLayerFlyout.createJobCalloutTitle.singleMetric",defaultMessage:"This layer can be used to create a single metric job"})))),Object(c.jsx)(u.EuiSpacer,{size:"m"}),Object(c.jsx)(u.EuiForm,null,Object(c.jsx)(u.EuiFormRow,{label:d.i18n.translate("xpack.ml.newJob.wizard.jobDetailsStep.jobId.title",{defaultMessage:"Job ID"}),error:w,isInvalid:""!==w},Object(c.jsx)(u.EuiFieldText,{"data-test-subj":`mlLensLayerJobIdInput_${t}`,value:E,onChange:e=>{I(e.target.value),V(L.VALIDATING)}})),Object(c.jsx)(u.EuiSpacer,{size:"s"}),Object(c.jsx)(u.EuiAccordion,{"data-test-subj":`mlLensLayerAdditionalSettingsButton_${t}`,id:"additional-section",buttonContent:d.i18n.translate("xpack.ml.embeddables.lensLayerFlyout.createJobCallout.additionalSettings.title",{defaultMessage:"Additional settings"})},Object(c.jsx)(u.EuiSpacer,{size:"s"}),Object(c.jsx)(u.EuiFormRow,{label:d.i18n.translate("xpack.ml.newJob.wizard.pickFieldsStep.bucketSpan.placeholder",{defaultMessage:"Bucket span"}),error:v,isInvalid:""!==v},Object(c.jsx)(u.EuiFieldText,{"data-test-subj":`mlLensLayerBucketSpanInput_${t}`,value:k,onChange:e=>{A(e.target.value),V(L.VALIDATING)}})),Object(c.jsx)(u.EuiSpacer,{size:"l"}),Object(c.jsx)(u.EuiFormRow,null,Object(c.jsx)(u.EuiCheckbox,{id:"startJob","data-test-subj":`mlLensLayerStartJobCheckbox_${t}`,checked:f,onChange:e=>{return t=e.target.checked,h(t),void T(t&&M);var t},label:d.i18n.translate("xpack.ml.embeddables.lensLayerFlyout.createJobCallout.additionalSettings.start",{defaultMessage:"Start the job after saving"})})),Object(c.jsx)(u.EuiSpacer,{size:"s"}),Object(c.jsx)(u.EuiFormRow,null,Object(c.jsx)(u.EuiCheckbox,{id:"realTime",disabled:!1===f,"data-test-subj":`mlLensLayerRealTimeCheckbox_${t}`,checked:M,onChange:e=>T(e.target.checked),label:d.i18n.translate("xpack.ml.embeddables.lensLayerFlyout.createJobCallout.additionalSettings.realTime",{defaultMessage:"Leave the job running for new data"})})),Object(c.jsx)(u.EuiSpacer,{size:"m"}))),Object(c.jsx)(u.EuiSpacer,{size:"m"}),Object(c.jsx)(u.EuiFlexGroup,null,Object(c.jsx)(u.EuiFlexItem,null,Object(c.jsx)(u.EuiButton,{disabled:J===L.VALIDATING||""===E||""!==w||""!==v,onClick:async function(){if(void 0===E)return;V(L.SAVING),G(null);const e=await B.createAndSaveJob(E,k,a,f,M,t),s=C(e);null===s?V(L.SAVE_SUCCESS):(V(L.SAVE_FAILED),G(s))}.bind(null,t),size:"s","data-test-subj":`mlLensLayerCreateJobButton_${t}`},Object(c.jsx)(b.FormattedMessage,{id:"xpack.ml.embeddables.lensLayerFlyout.createJobButton.saving",defaultMessage:"Create job"}))),Object(c.jsx)(u.EuiFlexItem,{grow:!1},Object(c.jsx)(u.EuiButtonEmpty,{onClick:function(){Object(m.redirectToADJobWizards)(a,t,o)}.bind(null,t),size:"s",iconType:"popout",iconSide:"right","data-test-subj":`mlLensLayerCreateWithWizardButton_${t}`},Object(c.jsx)(b.FormattedMessage,{id:"xpack.ml.embeddables.lensLayerFlyout.createJobButton",defaultMessage:"Create job using wizard"}))))):null,J===L.SAVE_SUCCESS?Object(c.jsx)(l.a.Fragment,null,Object(c.jsx)(u.EuiFlexGroup,{gutterSize:"s","data-test-subj":`mlLensLayerCompatible.jobCreated.success_${t}`},Object(c.jsx)(u.EuiFlexItem,{grow:!1},Object(c.jsx)(u.EuiText,{size:"s"},Object(c.jsx)(u.EuiIcon,{type:"checkInCircleFilled",color:"success"}))),Object(c.jsx)(u.EuiFlexItem,null,Object(c.jsx)(u.EuiText,{size:"s"},Object(c.jsx)(b.FormattedMessage,{id:"xpack.ml.embeddables.lensLayerFlyout.saveSuccess",defaultMessage:"Job created"})))),Object(c.jsx)(u.EuiSpacer,{size:"s"}),Object(c.jsx)(u.EuiButtonEmpty,{onClick:N.bind(null,e.jobType),flush:"left","data-test-subj":`mlLensLayerResultsButton_${t}`},!1===f?Object(c.jsx)(b.FormattedMessage,{id:"xpack.ml.embeddables.lensLayerFlyout.saveSuccess.resultsLink.jobList",defaultMessage:"View in job management page"}):e.jobType===O.f.MULTI_METRIC?Object(c.jsx)(b.FormattedMessage,{id:"xpack.ml.embeddables.lensLayerFlyout.saveSuccess.resultsLink.multiMetric",defaultMessage:"View results in Anomaly Explorer"}):Object(c.jsx)(b.FormattedMessage,{id:"xpack.ml.embeddables.lensLayerFlyout.saveSuccess.resultsLink.singleMetric",defaultMessage:"View results in Single Metric Viewer"}))):null,J===L.SAVING?Object(c.jsx)(u.EuiFlexGroup,null,Object(c.jsx)(u.EuiFlexItem,{grow:!1},Object(c.jsx)(b.FormattedMessage,{id:"xpack.ml.embeddables.lensLayerFlyout.creatingJob",defaultMessage:"Creating job"})),Object(c.jsx)(u.EuiFlexItem,{grow:!1},Object(c.jsx)(u.EuiLoadingSpinner,null))):null,J===L.SAVE_FAILED&&null!==D?Object(c.jsx)(l.a.Fragment,null,Object(c.jsx)(u.EuiSpacer,null),Object(c.jsx)(u.EuiCallOut,{color:"danger",title:D.text},D.errorText)):null)},C=e=>e.jobCreated.error?{text:d.i18n.translate("xpack.ml.embeddables.lensLayerFlyout.jobCreateError.jobCreated",{defaultMessage:"Job could not be created."}),errorText:Object(E.b)(e.jobCreated.error)}:e.datafeedCreated.error?{text:d.i18n.translate("xpack.ml.embeddables.lensLayerFlyout.jobCreateError.datafeedCreated",{defaultMessage:"Job created but datafeed could not be created."}),errorText:Object(E.b)(e.datafeedCreated.error)}:e.jobOpened.error?{text:d.i18n.translate("xpack.ml.embeddables.lensLayerFlyout.jobCreateError.jobOpened",{defaultMessage:"Job and datafeed created but the job could not be opened."}),errorText:Object(E.b)(e.jobOpened.error)}:e.datafeedStarted.error?{text:d.i18n.translate("xpack.ml.embeddables.lensLayerFlyout.jobCreateError.datafeedStarted",{defaultMessage:"Job and datafeed created but the datafeed could not be started."}),errorText:Object(E.b)(e.datafeedStarted.error)}:null,f=({layer:e})=>Object(c.jsx)(u.EuiFlexGroup,{gutterSize:"s",color:"subdued","data-test-subj":"mlLensLayerIncompatible"},Object(c.jsx)(u.EuiFlexItem,{grow:!1},Object(c.jsx)(u.EuiText,{size:"s"},Object(c.jsx)(u.EuiIcon,{type:"crossInACircleFilled",color:"subdued"}))),Object(c.jsx)(u.EuiFlexItem,null,Object(c.jsx)(u.EuiText,{color:"subdued",size:"s"},e.error?Object(E.b)(e.error):Object(c.jsx)(b.FormattedMessage,{id:"xpack.ml.embeddables.lensLayerFlyout.defaultLayerError",defaultMessage:"This layer cannot be used to create an anomaly detection job"})))),h=({layer:e,layerIndex:t,embeddable:a})=>Object(c.jsx)(l.a.Fragment,null,Object(c.jsx)(u.EuiSplitPanel.Outer,{grow:!0},Object(c.jsx)(u.EuiSplitPanel.Inner,null,Object(c.jsx)(u.EuiFlexGroup,{gutterSize:"s",alignItems:"center",responsive:!1},e.icon&&Object(c.jsx)(u.EuiFlexItem,{grow:!1},Object(c.jsx)(u.EuiIcon,{type:e.icon})),Object(c.jsx)(u.EuiFlexItem,{grow:!0},Object(c.jsx)(u.EuiText,{color:e.isCompatible?"":"subdued"},Object(c.jsx)("h5",null,e.label))))),Object(c.jsx)(u.EuiHorizontalRule,{margin:"none"}),Object(c.jsx)(u.EuiSplitPanel.Inner,{grow:!1,color:"plain"},e.isCompatible?Object(c.jsx)(I,{layer:e,layerIndex:t,embeddable:a}):Object(c.jsx)(f,{layer:e}))),Object(c.jsx)(u.EuiSpacer,null)),M=({onClose:e,embeddable:t})=>{const{euiTheme:a}=Object(u.useEuiTheme)(),{services:{data:r,lens:o}}=F(),[n,i]=Object(s.useState)([]);return Object(s.useEffect)((()=>{new m.VisualizationExtractor(r.dataViews).getResultLayersFromEmbeddable(t,o).then(i).catch((t=>{console.error("Layers could not be extracted from embeddable",t),e()}))}),[r,o,t]),Object(c.jsx)(l.a.Fragment,null,Object(c.jsx)(u.EuiFlyoutHeader,{hasBorder:!0},Object(c.jsx)(u.EuiTitle,{size:"s"},Object(c.jsx)("h3",null,Object(c.jsx)(b.FormattedMessage,{id:"xpack.ml.embeddables.lensLayerFlyout.title",defaultMessage:"Create anomaly detection job"}))),Object(c.jsx)(u.EuiSpacer,{size:"m"}),Object(c.jsx)(u.EuiText,{size:"s"},Object(c.jsx)(b.FormattedMessage,{id:"xpack.ml.embeddables.lensLayerFlyout.secondTitle",defaultMessage:"Select a compatible layer from the visualization {title} to create an anomaly detection job.",values:{title:t.getTitle()}}))),Object(c.jsx)(u.EuiFlyoutBody,{css:Object(c.css)({backgroundColor:a.colors.lightestShade},"","")},n.map(((e,a)=>Object(c.jsx)(h,{layer:e,layerIndex:a,embeddable:t})))),Object(c.jsx)(u.EuiFlyoutFooter,null,Object(c.jsx)(u.EuiFlexGroup,{justifyContent:"spaceBetween"},Object(c.jsx)(u.EuiFlexItem,{grow:!1},Object(c.jsx)(u.EuiButtonEmpty,{iconType:"cross",onClick:e,flush:"left"},Object(c.jsx)(b.FormattedMessage,{id:"xpack.ml.embeddables.lensLayerFlyout.closeButton",defaultMessage:"Close"}))))))};async function T(e,t,a,s,l){const{http:b,theme:{theme$:u},overlays:d,application:{currentAppId$:j}}=t;return new Promise((async(x,m)=>{try{const m=()=>{O.close(),x()},O=d.openFlyout(Object(n.toMountPoint)(Object(n.wrapWithTheme)(Object(c.jsx)(n.KibanaContextProvider,{services:{...t,share:a,data:s,lens:l,mlServices:Object(i.getMlGlobalServices)(b)}},Object(c.jsx)(M,{embeddable:e,onClose:()=>{m(),x()}})),u)),{"data-test-subj":"mlFlyoutLensLayerSelector",ownFocus:!0,closeButtonAriaLabel:"jobSelectorFlyout",onClose:m,size:"35vw"});j.pipe(Object(r.skip)(1),Object(r.takeUntil)(Object(o.from)(O.onClose)),Object(r.distinctUntilChanged)()).subscribe((()=>{O.close()}))}catch(e){m(e)}}))}}}]);