/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements. 
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[21],{208:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=a(54).__importDefault(a(204));t.default=function(e){i.default((function(){e()}))}},646:function(e,t,a){"use strict";a.r(t),a.d(t,"NotificationsPage",(function(){return q}));var i=a(17),s=a.n(i),l=a(45),n=a(24),o=a.n(n),c=a(2),r=a(44),d=a(48),u=a(166),m=a.n(u),b=a(208),f=a.n(b),j=a(8),p=a(80),g=a(85),O=a(13);const y={anomaly_detector:!0,data_frame_analytics:!0,trained_models:!0},x=({entityTypes:e=y,multiSelect:t=!0,selectedOptions:a,onSelectionChange:s,handleDuplicates:l=!1})=>{const{jobs:n,trainedModels:o,dataFrameAnalytics:d}=Object(p.a)(),{displayErrorToast:u}=Object(g.c)(),m=Object(r.euiPaletteColorBlindBehindText)(),[b,x]=Object(i.useState)(!0),[v,h]=Object(i.useState)([]),M=Object(i.useCallback)((async()=>{try{const t=[];if(null!=e&&e.anomaly_detector){const{jobIds:e}=await n.getAllJobAndGroupIds();t.push({label:c.i18n.translate("xpack.ml.mlEntitySelector.adOptionsLabel",{defaultMessage:"Anomaly detection jobs"}),isGroupLabelOption:!0,color:m[0],options:e.map((e=>({label:e,value:e,id:`anomaly_detector:${e}`,key:`anomaly_detector:${e}`,color:m[0],"data-test-subj":"mlAdJobOption"})))})}if(null!=e&&e.data_frame_analytics){const e=await d.getDataFrameAnalytics();e.count>0&&t.push({label:c.i18n.translate("xpack.ml.mlEntitySelector.dfaOptionsLabel",{defaultMessage:"Data frame analytics"}),isGroupLabelOption:!0,options:e.data_frame_analytics.map((({id:e})=>({label:e,value:e,id:`data_frame_analytics:${e}`,key:`data_frame_analytics:${e}`,color:m[2],"data-test-subj":"mlDfaJobOption"})))})}if(null!=e&&e.trained_models){const e=await o.getTrainedModels();e.length>0&&t.push({label:c.i18n.translate("xpack.ml.mlEntitySelector.trainedModelsLabel",{defaultMessage:"Trained models"}),isGroupLabelOption:!0,options:e.map((({model_id:e})=>({label:e,value:e,id:`trained_models:${e}`,key:`trained_models:${e}`,color:m[3],"data-test-subj":"mlTrainedModelOption"})))})}h(t)}catch(e){u(e,c.i18n.translate("xpack.ml.mlEntitySelector.fetchError",{defaultMessage:"Failed to fetch ML entities"}))}x(!1)}),[n,o,d,e,m,u]);f()((function(){M()}));const _=Object(i.useMemo)((()=>(null!=a?a:[]).flatMap((e=>{const t=v.flatMap((e=>e.options)).filter((t=>t.value===e.id));return t.length>0?t:[{value:e.id,label:e.id,key:`unknown:${e.id}`,"data-test-subj":`mlUnknownOption ${e.id}`}]}))),[v,a]),S=Object(i.useCallback)((e=>{if(!s)return;let t=e;if(l){const a=Object(j.countBy)(_,"value"),i=Object(j.countBy)(e,"value");t=t.filter((({value:e})=>!(a[e]>1&&i[e]<a[e])))}s(t.map((e=>{const[t]=e.key.split(":");return{id:e.value,type:t}})))}),[s,_,l]);return Object(O.jsx)(r.EuiComboBox,{autoFocus:!0,isLoading:b,singleSelection:!t,selectedOptions:_,options:v,onChange:S,fullWidth:!0,"data-test-subj":"mlEntitySelector_"+(b?"loading":"loaded"),isInvalid:!1})};var v={name:"18ji2p4",styles:"width:300px"};const h=s.a.memo((({query:e,onChange:t})=>{const[a,s]=Object(i.useState)(!1),n=e.hasOrFieldClause("job_id")||e.hasSimpleFieldClause("job_id"),o=e.getOrFieldClause("job_id"),c=e.getSimpleFieldClause("job_id"),d=s.bind(null,!1),u=Object(i.useMemo)((()=>{let e=[];return o&&Array.isArray(o.value)&&(e=o.value.map((e=>({id:e})))),c&&c.value&&e.push({id:c.value}),e}),[o,c]),m=Object(i.useCallback)((a=>{let i=e.removeOrFieldClauses("job_id");i=i.removeSimpleFieldClauses("job_id"),a.length>0&&(i=Object(j.uniqBy)(a,"id").reduce(((e,t)=>e.addOrFieldValue("job_id",t.id,!0,"eq")),i)),t(i)}),[t,e]),b=Object(O.jsx)(r.EuiFilterButton,{iconType:"arrowDown",iconSide:"right",onClick:s.bind(null,(e=>!e)),hasActiveFilters:n,numActiveFilters:n?u.length:void 0,grow:!0},Object(O.jsx)(l.FormattedMessage,{id:"xpack.ml.notifications.entityFilter",defaultMessage:"Entity"}));return Object(O.jsx)(r.EuiPopover,{button:b,isOpen:a,closePopover:d,panelPaddingSize:"none",anchorPosition:"downCenter"},Object(O.jsx)(r.EuiPanel,{paddingSize:"s",css:v},Object(O.jsx)(x,{selectedOptions:u,onSelectionChange:m,handleDuplicates:!0})))}));var M=a(264);const _="error",S="info",k="warning";var F=a(159),E=a(149),T=a(126),w=a(141),C=a(198),L=a(96),A=a(0);const D={[_]:"danger",[k]:"warning",[S]:"default"},I=()=>{const{services:{mlServices:{mlApiServices:e}}}=Object(p.b)(),{displayErrorToast:t}=Object(g.c)(),{lastCheckedAt:a,setLastCheckedAt:n,notificationsCounts:u,latestRequestedAt:b}=Object(M.b)(),j=Object(E.c)(),y=Object(E.b)();f()((function(){j.setTime({from:o()(b).toISOString(),to:"now"})}));const[x,v]=Object(i.useState)(!0),[I,N]=Object(i.useState)([]),[B,z]=Object(i.useState)(0),[P,q]=Object(i.useState)(""),$=Object(T.a)(d.FIELD_FORMAT_IDS.DATE),[R,Q]=Object(L.b)(A.b.NOTIFICATIONS,{pageIndex:0,pageSize:25,sortField:"timestamp",sortDirection:"desc"}),{onTableChange:G,pagination:J,sorting:W}=Object(C.a)(B,R,Q),U=Object(w.a)(),V=R.queryText,H=Object(i.useMemo)((()=>{try{return q(""),r.EuiSearchBar.Query.parse(null!=V?V:"")}catch(e){q(e.message)}}),[V,q]),K=Object(i.useCallback)((async()=>{if(!H)return;const a=r.EuiSearchBar.Query.toESQueryString(H);try{v(!0);const t=await e.notifications.findMessages({sortField:W.sort.field,sortDirection:W.sort.direction,earliest:y.from,latest:y.to,queryString:a});N(t.results),z(t.total)}catch(e){t(e,c.i18n.translate("xpack.ml.notifications.fetchFailedError",{defaultMessage:"Fetch notifications failed"}))}v(!1)}),[W,H,e.notifications,t,y]);Object(i.useEffect)((function(){const e=J.pageIndex*J.pageSize,t=I.slice(e,e+J.pageSize),i=Math.max(...t.map((e=>e.timestamp)),null!=a?a:0);i!==a&&0!==i&&n(i)}),[a,n,I,J.pageIndex,J.pageSize]),m()((function(){K()}),500,[W,H,U]);const X=Object(i.useMemo)((()=>[{id:"timestamp",field:"timestamp",name:Object(O.jsx)(l.FormattedMessage,{id:"xpack.ml.notifications.timeLabel",defaultMessage:"Time"}),sortable:!0,truncateText:!1,"data-test-subj":"mlNotificationTime",width:"250px",render:e=>$(e)},{field:"level",name:Object(O.jsx)(l.FormattedMessage,{id:"xpack.ml.notifications.levelLabel",defaultMessage:"Level"}),sortable:!0,truncateText:!1,"data-test-subj":"mlNotificationLevel",render:e=>Object(O.jsx)(r.EuiBadge,{color:D[e]},e),width:"100px"},{field:"job_type",name:Object(O.jsx)(l.FormattedMessage,{id:"xpack.ml.notifications.typeLabel",defaultMessage:"Type"}),sortable:!0,truncateText:!1,"data-test-subj":"mlNotificationType",render:e=>Object(O.jsx)(r.EuiBadge,{color:"hollow"},e),width:"200px"},{field:"job_id",name:Object(O.jsx)(l.FormattedMessage,{id:"xpack.ml.notifications.entityLabel",defaultMessage:"Entity ID"}),sortable:!0,truncateText:!1,"data-test-subj":"mlNotificationEntity",width:"200px"},{field:"message",name:Object(O.jsx)(l.FormattedMessage,{id:"xpack.ml.notifications.messageLabel",defaultMessage:"Message"}),sortable:!1,truncateText:!1,"data-test-subj":"mlNotificationMessage"}]),[$]),Y=Object(i.useMemo)((()=>[{type:"field_value_selection",field:"level",name:c.i18n.translate("xpack.ml.notifications.filters.level.name",{defaultMessage:"Level"}),multiSelect:"or",options:[{value:_,name:c.i18n.translate("xpack.ml.notifications.filters.level.error",{defaultMessage:"Error"}),field:"level"},{value:k,name:c.i18n.translate("xpack.ml.notifications.filters.level.warning",{defaultMessage:"Warning"}),field:"level"},{value:S,name:c.i18n.translate("xpack.ml.notifications.filters.level.info",{defaultMessage:"Info"}),field:"level"}]},{type:"field_value_selection",field:"job_type",name:c.i18n.translate("xpack.ml.notifications.filters.level.type",{defaultMessage:"Type"}),multiSelect:"or",options:[{value:"anomaly_detector",name:c.i18n.translate("xpack.ml.notifications.filters.type.anomalyDetector",{defaultMessage:"Anomaly Detection"})},{value:"data_frame_analytics",name:c.i18n.translate("xpack.ml.notifications.filters.type.dfa",{defaultMessage:"Data Frame Analytics"})},{value:"inference",name:c.i18n.translate("xpack.ml.notifications.filters.type.inference",{defaultMessage:"Inference"})},{value:"system",name:c.i18n.translate("xpack.ml.notifications.filters.type.system",{defaultMessage:"System"})}]},{type:"custom_component",component:h}]),[]),Z=Object.values(u).reduce(((e,t)=>e+t));return Object(O.jsx)(s.a.Fragment,null,Object(O.jsx)(F.a,{onCloseFlyout:K,forceRefresh:x}),Z&&!x?Object(O.jsx)(s.a.Fragment,null,Object(O.jsx)(r.EuiCallOut,{size:"s",title:Object(O.jsx)(l.FormattedMessage,{id:"xpack.ml.notifications.newNotificationsMessage",defaultMessage:"There {newNotificationsCount, plural, one {is # notification} other {are # notifications}} since {sinceDate}. Refresh the page to view updates.",values:{sinceDate:$(b),newNotificationsCount:Z}}),iconType:"bell"}),Object(O.jsx)(r.EuiSpacer,{size:"m"})):null,Object(O.jsx)(r.EuiSearchBar,{query:H,box:{placeholder:c.i18n.translate("xpack.ml.notifications.searchPlaceholder",{defaultMessage:"Search for notifications. Example: job_type:anomaly_detector -level:(info) Datafeed"}),incremental:!1,schema:{strict:!0,fields:{level:{type:"string",name:"level",searchable:!1,aggregatable:!0},job_type:{type:"string",name:"job_type",searchable:!1,aggregatable:!0},job_id:{type:"string",name:"job_id",searchable:!1,aggregatable:!0},message:{type:"string",name:"message",searchable:!0,aggregatable:!1}}},"data-test-subj":"mlNotificationsSearchBarInput"},filters:Y,onChange:e=>{Q({queryText:e.queryText})},"data-test-subj":"mlNotificationsSearchBar"}),Object(O.jsx)(r.EuiSpacer,{size:"m"}),P?Object(O.jsx)(s.a.Fragment,null,Object(O.jsx)(r.EuiCallOut,{size:"s",title:Object(O.jsx)(l.FormattedMessage,{id:"xpack.ml.notifications.invalidQueryError",defaultMessage:"Query is not valid: "}),color:"danger",iconType:"alert"},Object(O.jsx)("p",null,P)),Object(O.jsx)(r.EuiSpacer,{size:"m"})):null,Object(O.jsx)(r.EuiInMemoryTable,{columns:X,hasActions:!1,isExpandable:!1,isSelectable:!1,items:I,itemId:"id",loading:x,rowProps:e=>({"data-test-subj":`mlNotificationsTableRow row-${e.id}`}),pagination:J,onChange:G,sorting:W,"data-test-subj":x?"mlNotificationsTable loading":"mlNotificationsTable loaded",message:Object(O.jsx)(l.FormattedMessage,{id:"xpack.ml.notifications.noItemsFoundMessage",defaultMessage:"No notifications found"})}))};var N=a(94),B=a(183),z=a(186),P=a(107);const q=()=>{const{services:{docLinks:e}}=Object(p.b)(),t=e.links.ml.guide;return Object(p.g)({timeRangeSelector:!0,autoRefreshSelector:!0}),Object(O.jsx)("div",null,Object(O.jsx)(N.a,null,Object(O.jsx)(l.FormattedMessage,{id:"xpack.ml.notifications.notificationsLabel",defaultMessage:"Notifications"})),Object(O.jsx)(B.a,null),Object(O.jsx)(z.a,null),Object(O.jsx)(I,null),Object(O.jsx)(P.a,{docLink:t}))};t.default=q}}]);