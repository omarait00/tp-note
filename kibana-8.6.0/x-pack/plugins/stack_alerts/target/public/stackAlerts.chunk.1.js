/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements. 
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.stackAlerts_bundle_jsonpfunction=window.stackAlerts_bundle_jsonpfunction||[]).push([[1],{25:function(e,t,a){"use strict";var s,r=function(){var e={};return function(t){if(void 0===e[t]){var a=document.querySelector(t);if(window.HTMLIFrameElement&&a instanceof window.HTMLIFrameElement)try{a=a.contentDocument.head}catch(e){a=null}e[t]=a}return e[t]}}(),i=[];function o(e){for(var t=-1,a=0;a<i.length;a++)if(i[a].identifier===e){t=a;break}return t}function n(e,t){for(var a={},s=[],r=0;r<e.length;r++){var n=e[r],l=t.base?n[0]+t.base:n[0],c=a[l]||0,u="".concat(l," ").concat(c);a[l]=c+1;var d=o(u),p={css:n[1],media:n[2],sourceMap:n[3]};-1!==d?(i[d].references++,i[d].updater(p)):i.push({identifier:u,updater:h(p,t),references:1}),s.push(u)}return s}function l(e){var t=document.createElement("style"),s=e.attributes||{};if(void 0===s.nonce){var i=a.nc;i&&(s.nonce=i)}if(Object.keys(s).forEach((function(e){t.setAttribute(e,s[e])})),"function"==typeof e.insert)e.insert(t);else{var o=r(e.insert||"head");if(!o)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");o.appendChild(t)}return t}var c,u=(c=[],function(e,t){return c[e]=t,c.filter(Boolean).join("\n")});function d(e,t,a,s){var r=a?"":s.media?"@media ".concat(s.media," {").concat(s.css,"}"):s.css;if(e.styleSheet)e.styleSheet.cssText=u(t,r);else{var i=document.createTextNode(r),o=e.childNodes;o[t]&&e.removeChild(o[t]),o.length?e.insertBefore(i,o[t]):e.appendChild(i)}}function p(e,t,a){var s=a.css,r=a.media,i=a.sourceMap;if(r?e.setAttribute("media",r):e.removeAttribute("media"),i&&"undefined"!=typeof btoa&&(s+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),e.styleSheet)e.styleSheet.cssText=s;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(s))}}var b=null,j=0;function h(e,t){var a,s,r;if(t.singleton){var i=j++;a=b||(b=l(t)),s=d.bind(null,a,i,!1),r=d.bind(null,a,i,!0)}else a=l(t),s=p.bind(null,a,t),r=function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(a)};return s(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;s(e=t)}else r()}}e.exports=function(e,t){(t=t||{}).singleton||"boolean"==typeof t.singleton||(t.singleton=(void 0===s&&(s=Boolean(window&&document&&document.all&&!window.atob)),s));var a=n(e=e||[],t);return function(e){if(e=e||[],"[object Array]"===Object.prototype.toString.call(e)){for(var s=0;s<a.length;s++){var r=o(a[s]);i[r].references--}for(var l=n(e,t),c=0;c<a.length;c++){var u=o(a[c]);0===i[u].references&&(i[u].updater(),i.splice(u,1))}a=l}}}},26:function(e,t,a){"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var a=function(e,t){var a,s,r,i=e[1]||"",o=e[3];if(!o)return i;if(t&&"function"==typeof btoa){var n=(a=o,s=btoa(unescape(encodeURIComponent(JSON.stringify(a)))),r="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(s),"/*# ".concat(r," */")),l=o.sources.map((function(e){return"/*# sourceURL=".concat(o.sourceRoot||"").concat(e," */")}));return[i].concat(l).concat([n]).join("\n")}return[i].join("\n")}(t,e);return t[2]?"@media ".concat(t[2]," {").concat(a,"}"):a})).join("")},t.i=function(e,a,s){"string"==typeof e&&(e=[[null,e,""]]);var r={};if(s)for(var i=0;i<this.length;i++){var o=this[i][0];null!=o&&(r[o]=!0)}for(var n=0;n<e.length;n++){var l=[].concat(e[n]);s&&r[l[0]]||(a&&(l[2]?l[2]="".concat(a," and ").concat(l[2]):l[2]=a),t.push(l))}},t}},27:function(e,t,a){"use strict";a.d(t,"a",(function(){return s}));const s="stackAlerts"},28:function(e,t,a){e.exports=a(15)(3)},29:function(e,t,a){e.exports=a(15)(2)},30:function(e,t,a){"use strict";a.d(t,"a",(function(){return d}));var s=a(2),r=a(0),i=a(3),o=a(14),n=a(13),l=a(5),c=a(1),u=a(12);const d=({index:e,esFields:t,timeField:a,errors:d,onIndexChange:p,onTimeFieldChange:b})=>{const{http:j}=Object(l.useKibana)().services,[h,m]=Object(s.useState)(!1),[x,g]=Object(s.useState)([]),[y,O]=Object(s.useState)(!1),[f,v]=Object(s.useState)([c.firstFieldOption]),E=Object(i.debounce)((async e=>{O(!0),g(await Object(c.getIndexOptions)(j,e)),O(!1)}),250);Object(s.useEffect)((()=>{const e=Object(c.getTimeFieldOptions)(t);v([c.firstFieldOption,...e])}),[t]);const w=()=>{m(!1),void 0===a&&b("")};return Object(u.jsx)(n.EuiPopover,{id:"indexPopover",button:Object(u.jsx)(n.EuiExpression,{display:"columns","data-test-subj":"selectIndexExpression",description:r.i18n.translate("xpack.stackAlerts.components.ui.alertParams.indexLabel",{defaultMessage:"index"}),value:e&&e.length>0?(e=>{const t=e.map(((t,a)=>Object(u.jsx)("p",{key:a},t,a<e.length-1?",":null)));return Object(u.jsx)("div",null,t)})(e):r.i18n.translate("xpack.stackAlerts.components.ui.alertParams.indexPlaceholder",{defaultMessage:"Select an index"}),isActive:h,onClick:()=>{m(!0)},isInvalid:!(e&&e.length>0&&""!==a)}),isOpen:h,closePopover:w,ownFocus:!0,anchorPosition:"downLeft",zIndex:8e3,display:"block"},Object(u.jsx)("div",{style:{width:"450px"}},Object(u.jsx)(n.EuiPopoverTitle,null,Object(u.jsx)(n.EuiFlexGroup,{alignItems:"center",gutterSize:"s"},Object(u.jsx)(n.EuiFlexItem,null,r.i18n.translate("xpack.stackAlerts.components.ui.alertParams.indexButtonLabel",{defaultMessage:"index"})),Object(u.jsx)(n.EuiFlexItem,{grow:!1},Object(u.jsx)(n.EuiButtonIcon,{"data-test-subj":"closePopover",iconType:"cross",color:"danger","aria-label":r.i18n.translate("xpack.stackAlerts.components.ui.alertParams.closeIndexPopoverLabel",{defaultMessage:"Close"}),onClick:w})))),Object(u.jsx)(n.EuiFormRow,{id:"indexSelectSearchBox",fullWidth:!0,label:Object(u.jsx)(o.FormattedMessage,{id:"xpack.stackAlerts.components.ui.alertParams.indicesToQueryLabel",defaultMessage:"Indices to query"}),isInvalid:d.index.length>0&&null!=e&&e.length>0,error:d.index,helpText:Object(u.jsx)(o.FormattedMessage,{id:"xpack.stackAlerts.components.ui.alertParams.howToBroadenSearchQueryDescription",defaultMessage:"Use * to broaden your query."})},Object(u.jsx)(n.EuiComboBox,{fullWidth:!0,async:!0,isLoading:y,isInvalid:d.index.length>0&&null!=e&&e.length>0,noSuggestions:!x.length,options:x,"data-test-subj":"thresholdIndexesComboBox",selectedOptions:(e||[]).map((e=>({label:e,value:e}))),onChange:async e=>{const t=e.map((e=>e.value)).filter(i.isString);if(p(t),0===t.length)v([c.firstFieldOption]);else{const e=await Object(c.getFields)(j,t),a=Object(c.getTimeFieldOptions)(e);v([c.firstFieldOption,...a])}},onSearchChange:E,onBlur:()=>{e||p([])}})),Object(u.jsx)(n.EuiFormRow,{id:"thresholdTimeField",fullWidth:!0,label:Object(u.jsx)(o.FormattedMessage,{id:"xpack.stackAlerts.components.ui.alertParams.timeFieldLabel",defaultMessage:"Time field"}),isInvalid:d.timeField.length>0&&void 0!==a,error:d.timeField},Object(u.jsx)(n.EuiSelect,{options:f,isInvalid:d.timeField.length>0&&void 0!==a,fullWidth:!0,name:"thresholdTimeField","data-test-subj":"thresholdAlertTimeFieldSelect",value:a||"",onChange:e=>{b(e.target.value)},onBlur:()=>{void 0===a&&b("")}}))))}},32:function(e,t,a){"use strict";e.exports=function e(t,a){if(t===a)return!0;if(t&&a&&"object"==typeof t&&"object"==typeof a){if(t.constructor!==a.constructor)return!1;var s,r,i;if(Array.isArray(t)){if((s=t.length)!=a.length)return!1;for(r=s;0!=r--;)if(!e(t[r],a[r]))return!1;return!0}if(t.constructor===RegExp)return t.source===a.source&&t.flags===a.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===a.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===a.toString();if((s=(i=Object.keys(t)).length)!==Object.keys(a).length)return!1;for(r=s;0!=r--;)if(!Object.prototype.hasOwnProperty.call(a,i[r]))return!1;for(r=s;0!=r--;){var o=i[r];if(!e(t[o],a[o]))return!1}return!0}return t!=t&&a!=a}},43:function(e,t){ace.define("ace/theme/github",["require","exports","module","ace/lib/dom"],(function(e,t,a){t.isDark=!1,t.cssClass="ace-github",t.cssText='.ace-github .ace_gutter {background: #e8e8e8;color: #AAA;}.ace-github  {background: #fff;color: #000;}.ace-github .ace_keyword {font-weight: bold;}.ace-github .ace_string {color: #D14;}.ace-github .ace_variable.ace_class {color: teal;}.ace-github .ace_constant.ace_numeric {color: #099;}.ace-github .ace_constant.ace_buildin {color: #0086B3;}.ace-github .ace_support.ace_function {color: #0086B3;}.ace-github .ace_comment {color: #998;font-style: italic;}.ace-github .ace_variable.ace_language  {color: #0086B3;}.ace-github .ace_paren {font-weight: bold;}.ace-github .ace_boolean {font-weight: bold;}.ace-github .ace_string.ace_regexp {color: #009926;font-weight: normal;}.ace-github .ace_variable.ace_instance {color: teal;}.ace-github .ace_constant.ace_language {font-weight: bold;}.ace-github .ace_cursor {color: black;}.ace-github.ace_focus .ace_marker-layer .ace_active-line {background: rgb(255, 255, 204);}.ace-github .ace_marker-layer .ace_active-line {background: rgb(245, 245, 245);}.ace-github .ace_marker-layer .ace_selection {background: rgb(181, 213, 255);}.ace-github.ace_multiselect .ace_selection.ace_start {box-shadow: 0 0 3px 0px white;}.ace-github.ace_nobold .ace_line > span {font-weight: normal !important;}.ace-github .ace_marker-layer .ace_step {background: rgb(252, 255, 0);}.ace-github .ace_marker-layer .ace_stack {background: rgb(164, 229, 101);}.ace-github .ace_marker-layer .ace_bracket {margin: -1px 0 0 -1px;border: 1px solid rgb(192, 192, 192);}.ace-github .ace_gutter-active-line {background-color : rgba(0, 0, 0, 0.07);}.ace-github .ace_marker-layer .ace_selected-word {background: rgb(250, 250, 255);border: 1px solid rgb(200, 200, 250);}.ace-github .ace_invisible {color: #BFBFBF}.ace-github .ace_print-margin {width: 1px;background: #e8e8e8;}.ace-github .ace_indent-guide {background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAACCAYAAACZgbYnAAAAE0lEQVQImWP4////f4bLly//BwAmVgd1/w11/gAAAABJRU5ErkJggg==") right repeat-y;}',e("../lib/dom").importCssString(t.cssText,t.cssClass)}))},44:function(e,t,a){switch(window.__kbnThemeTag__){case"v8dark":return a(45);case"v8light":return a(47)}},45:function(e,t,a){var s=a(25),r=a(46);"string"==typeof(r=r.__esModule?r.default:r)&&(r=[[e.i,r,""]]);s(r,{insert:"head",singleton:!1}),e.exports=r.locals||{}},46:function(e,t,a){(t=a(26)(!1)).push([e.i,".searchSourceAlertFilters .euiExpression__value{width:80%}.dscExpressionParam.euiExpression{margin-left:0}",""]),e.exports=t},47:function(e,t,a){var s=a(25),r=a(48);"string"==typeof(r=r.__esModule?r.default:r)&&(r=[[e.i,r,""]]);s(r,{insert:"head",singleton:!1}),e.exports=r.locals||{}},48:function(e,t,a){(t=a(26)(!1)).push([e.i,".searchSourceAlertFilters .euiExpression__value{width:80%}.dscExpressionParam.euiExpression{margin-left:0}",""]),e.exports=t},49:function(e,t,a){"use strict";a.r(t);var s=a(28),r=a.n(s),i=a(2),o=a.n(i),n=a(32),l=a.n(n),c=(a(43),a(13)),u=a(0);let d;a(44),function(e){e.esQuery="esQuery",e.searchSource="searchSource"}(d||(d={}));var p=a(16),b=a(14),j=a(22),h=a(27),m=a(6),x=a(17),g=a(7),y=a(12);const O=e=>({id:e.id,title:e.title,name:e.name}),f=({metadata:e={adHocDataViewList:[],isManagementPage:!0},dataView:t,onSelectDataView:a,onChangeMetaData:s})=>{var r;const{dataViews:o,dataViewEditor:n}=Object(g.b)(),[l,d]=Object(i.useState)([]),[p,j]=Object(i.useState)(!1),h=Object(i.useRef)(),m=Object(i.useMemo)((()=>[...l,...e.adHocDataViewList.map(O)]),[l,e.adHocDataViewList]),f=Object(i.useCallback)((()=>j(!1)),[]),v=Object(i.useCallback)((async e=>{const t=await o.get(e);a(t),f()}),[f,o,a]),E=Object(i.useCallback)((async()=>{const e=await o.getIds(),t=await Promise.all(e.map((e=>o.get(e))));d(t.map(O))}),[o]),w=Object(i.useCallback)((t=>{s({...e,adHocDataViewList:[...e.adHocDataViewList,t]})}),[e,s]),S=Object(i.useMemo)((()=>n.userPermissions.editDataView()?()=>{h.current=n.openEditor({onSave:async e=>{e.id&&(e.isPersisted()||w(e),await E(),await v(e.id))},allowAdHocDataView:!0})}:void 0),[n,E,v,w]);Object(i.useEffect)((()=>()=>{h.current&&h.current()}),[]),Object(i.useEffect)((()=>{E()}),[E]);const k=Object(c.useEuiPaddingCSS)("left"),F=Object(i.useCallback)((async e=>{var t;const a=await o.create({title:e});"date"===(null===(t=a.fields.getByName("@timestamp"))||void 0===t?void 0:t.type)&&(a.timeFieldName="@timestamp"),w(a),v(a.id)}),[o,w,v]);return m?Object(y.jsx)(c.EuiPopover,{id:"dataViewPopover",button:Object(y.jsx)(c.EuiExpression,{display:"columns","data-test-subj":"selectDataViewExpression",description:u.i18n.translate("xpack.stackAlerts.components.ui.alertParams.dataViewLabel",{defaultMessage:"data view"}),value:null!==(r=null==t?void 0:t.getName())&&void 0!==r?r:u.i18n.translate("xpack.stackAlerts.components.ui.alertParams.dataViewPlaceholder",{defaultMessage:"Select a data view"}),isActive:p,onClick:()=>{j(!0)},isInvalid:!(null!=t&&t.id)}),isOpen:p,closePopover:f,ownFocus:!0,anchorPosition:"downLeft",display:"block"},Object(y.jsx)("div",{style:{width:"450px"},"data-test-subj":"chooseDataViewPopoverContent"},Object(y.jsx)(c.EuiPopoverTitle,null,Object(y.jsx)(c.EuiFlexGroup,{alignItems:"center",gutterSize:"s"},Object(y.jsx)(c.EuiFlexItem,null,u.i18n.translate("xpack.stackAlerts.components.ui.alertParams.dataViewPopoverTitle",{defaultMessage:"Data view"})),Object(y.jsx)(c.EuiFlexItem,{grow:!1},Object(y.jsx)(c.EuiButtonIcon,{"data-test-subj":"closeDataViewPopover",iconType:"cross",color:"danger","aria-label":u.i18n.translate("xpack.stackAlerts.components.ui.alertParams.closeDataViewPopoverLabel",{defaultMessage:"Close"}),onClick:f})))),Object(y.jsx)(x.DataViewSelector,{currentDataViewId:null==t?void 0:t.id,dataViewsList:m,setPopoverIsOpen:j,onChangeDataView:v,onCreateDefaultAdHocDataView:F,isTextBasedLangSelected:!1}),S?Object(y.jsx)(c.EuiPopoverFooter,{paddingSize:"none"},Object(y.jsx)(c.EuiButtonEmpty,{css:k.s,iconType:"plusInCircleFilled","data-test-subj":"chooseDataViewPopover.createDataViewButton",onClick:()=>{f(),S()}},u.i18n.translate("xpack.stackAlerts.components.ui.alertParams.dataViewPopover.createDataViewButton",{defaultMessage:"Create a data view"}))):Object(y.jsx)(c.EuiPopoverFooter,null,Object(y.jsx)(c.EuiText,{color:"subdued",size:"xs"},Object(y.jsx)(b.FormattedMessage,{id:"xpack.stackAlerts.components.ui.alertParams.dataViewPopover.createDataViewButton.noPermissionDescription",defaultMessage:"You need additional privileges to create data views. Contact your administrator."}))))):null};var v=a(1);const E={result:null,error:null,isLoading:!1};function w(e){var t;return"number"==typeof e?e:null!==(t=null==e?void 0:e.value)&&void 0!==t?t:0}const S=({fetch:e,copyQuery:t,hasValidationErrors:a})=>{const{onTestQuery:s,testQueryResult:r,testQueryError:n,testQueryLoading:l}=function(e){const[t,a]=Object(i.useState)(E);return Object(i.useEffect)((()=>{a(E)}),[e]),{onTestQuery:Object(i.useCallback)((async()=>{a({result:null,error:null,isLoading:!0});try{const{nrOfDocs:t,timeWindow:s}=await e();a({result:u.i18n.translate("xpack.stackAlerts.esQuery.ui.numQueryMatchesText",{defaultMessage:"Query matched {count} documents in the last {window}.",values:{count:t,window:s}}),error:null,isLoading:!1})}catch(e){var t,s,r,i,o;const n=(null==e||null===(t=e.body)||void 0===t||null===(s=t.attributes)||void 0===s||null===(r=s.error)||void 0===r||null===(i=r.root_cause[0])||void 0===i?void 0:i.reason)||(null==e||null===(o=e.body)||void 0===o?void 0:o.message);a({result:null,error:u.i18n.translate("xpack.stackAlerts.esQuery.ui.queryError",{defaultMessage:"Error testing query: {message}",values:{message:n?`${e.message}: ${n}`:e.message}}),isLoading:!1})}}),[e]),testQueryResult:t.result,testQueryError:t.error,testQueryLoading:t.isLoading}}(e),[d,p]=Object(i.useState)(null);return Object(y.jsx)(o.a.Fragment,null,Object(y.jsx)(c.EuiFormRow,null,Object(y.jsx)(c.EuiFlexGroup,{alignItems:"center",responsive:!1,gutterSize:"s"},Object(y.jsx)(c.EuiFlexItem,{grow:!1},Object(y.jsx)(c.EuiButton,{"data-test-subj":"testQuery",color:"primary",iconSide:"left",iconType:"playFilled",onClick:()=>{s()},disabled:a,isLoading:l,size:"s"},Object(y.jsx)(b.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.testQuery",defaultMessage:"Test query"}))),t&&Object(y.jsx)(c.EuiFlexItem,{grow:!1},Object(y.jsx)(c.EuiToolTip,{content:d,onMouseOut:()=>{p(null)}},Object(y.jsx)(c.EuiButtonEmpty,{"data-test-subj":"copyQuery",color:"primary",iconSide:"left",iconType:"copyClipboard",onClick:()=>{Object(c.copyToClipboard)(t())&&p(Object(y.jsx)(b.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.queryCopiedToClipboard",defaultMessage:"Copied"}))},disabled:a,isLoading:l,size:"s"},Object(y.jsx)(b.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.copyQuery",defaultMessage:"Copy query"})))))),l&&Object(y.jsx)(c.EuiFormRow,null,Object(y.jsx)(c.EuiText,{color:"subdued",size:"s"},Object(y.jsx)("p",null,Object(y.jsx)(b.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.testQueryIsExecuted",defaultMessage:"Query is executed."})))),r&&Object(y.jsx)(c.EuiFormRow,null,Object(y.jsx)(c.EuiText,{"data-test-subj":"testQuerySuccess",color:"subdued",size:"s"},Object(y.jsx)("p",null,r))),n&&Object(y.jsx)(c.EuiFormRow,null,Object(y.jsx)(c.EuiText,{"data-test-subj":"testQueryError",color:"danger",size:"s"},Object(y.jsx)("p",null,n))))};var k=a(29),F=a.n(k);const C={name:"1y0ex1",styles:"max-width:400px"};class threshold_help_popover_QueryThresholdHelpPopover extends i.Component{constructor(...e){super(...e),F()(this,"state",{isPopoverOpen:!1}),F()(this,"PopoverStyles",{name:"1y0ex1",styles:"max-width:400px"}),F()(this,"_togglePopover",(()=>{this.setState((e=>({isPopoverOpen:!e.isPopoverOpen})))})),F()(this,"_closePopover",(()=>{this.setState({isPopoverOpen:!1})}))}_renderContent(){return Object(y.jsx)("div",{css:C},Object(y.jsx)(c.EuiText,{grow:!1,size:"s"},Object(y.jsx)("p",null,Object(y.jsx)(b.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.thresholdHelp.threshold",defaultMessage:"Each time the rule runs, it checks whether the number of documents that match your query meets this threshold."})),Object(y.jsx)("p",null,Object(y.jsx)(b.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.thresholdHelp.timeWindow",defaultMessage:"The time window indicates how far back in time to search. To avoid gaps in detection, set this value greater than or equal to the value you chose for the {checkField} field.",values:{checkField:Object(y.jsx)("b",null,"Check every")}})),Object(y.jsx)("p",null,Object(y.jsx)(b.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.thresholdHelp.duplicateMatches",defaultMessage:"If {excludePrevious} is turned on, a document that matches the query in multiple runs will be used in only the first threshold calculation.",values:{excludePrevious:Object(y.jsx)("b",null,"Exclude matches from previous runs")}}))))}render(){return Object(y.jsx)(c.EuiPopover,{id:"thresholdHelpPopover",anchorPosition:"upLeft",button:Object(y.jsx)(c.EuiButtonIcon,{onClick:this._togglePopover,iconType:"documentation","aria-label":u.i18n.translate("xpack.stackAlerts.esQuery.ui.thresholdHelp.ariaLabel",{defaultMessage:"Help"})}),isOpen:this.state.isPopoverOpen,closePopover:this._closePopover,repositionOnScroll:!0,ownFocus:!0},Object(y.jsx)(c.EuiPopoverTitle,null,Object(y.jsx)(b.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.thresholdHelp.title",defaultMessage:"Set the threshold and time window"})),this._renderContent())}}const T=({thresholdComparator:e,threshold:t,timeWindowSize:a,timeWindowUnit:s,size:r,errors:i,hasValidationErrors:n,onChangeThreshold:l,onChangeThresholdComparator:d,onChangeWindowSize:p,onChangeWindowUnit:j,onChangeSizeValue:h,onTestFetch:x,onCopyQuery:g,excludeHitsFromPreviousRun:O,onChangeExcludeHitsFromPreviousRun:f})=>Object(y.jsx)(o.a.Fragment,null,Object(y.jsx)(c.EuiTitle,{size:"xs"},Object(y.jsx)("h4",null,Object(y.jsx)(b.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.conditionsPrompt",defaultMessage:"Set the threshold and time window"})," ",Object(y.jsx)(threshold_help_popover_QueryThresholdHelpPopover,null))),Object(y.jsx)(c.EuiSpacer,{size:"s"}),Object(y.jsx)(v.ThresholdExpression,{"data-test-subj":"thresholdExpression",thresholdComparator:null!=e?e:m.a.THRESHOLD_COMPARATOR,threshold:null!=t?t:m.a.THRESHOLD,errors:i,display:"fullWidth",popupPosition:"upLeft",onChangeSelectedThreshold:l,onChangeSelectedThresholdComparator:d}),Object(y.jsx)(v.ForLastExpression,{"data-test-subj":"forLastExpression",popupPosition:"upLeft",timeWindowSize:a,timeWindowUnit:s,display:"fullWidth",errors:i,onChangeWindowSize:p,onChangeWindowUnit:j}),Object(y.jsx)(c.EuiSpacer,{size:"s"}),Object(y.jsx)(c.EuiFlexGroup,{alignItems:"center",responsive:!1,gutterSize:"xs"},Object(y.jsx)(c.EuiFlexItem,{grow:!1},Object(y.jsx)(c.EuiTitle,{size:"xs"},Object(y.jsx)("h5",null,Object(y.jsx)(b.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.selectSizePrompt",defaultMessage:"Set the number of documents to send"})))),Object(y.jsx)(c.EuiFlexItem,{grow:!1},Object(y.jsx)(c.EuiIconTip,{position:"right",color:"subdued",type:"questionInCircle",content:u.i18n.translate("xpack.stackAlerts.esQuery.ui.selectSizePrompt.toolTip",{defaultMessage:"Specify the number of documents to pass to the configured actions when the threshold condition is met."})}))),Object(y.jsx)(c.EuiSpacer,{size:"s"}),Object(y.jsx)(v.ValueExpression,{description:u.i18n.translate("xpack.stackAlerts.esQuery.ui.sizeExpression",{defaultMessage:"Size"}),"data-test-subj":"sizeValueExpression",value:r,errors:i.size,display:"fullWidth",popupPosition:"upLeft",onChangeSelectedValue:h}),Object(y.jsx)(c.EuiSpacer,{size:"m"}),Object(y.jsx)(c.EuiFormRow,null,Object(y.jsx)(c.EuiCheckbox,{"data-test-subj":"excludeHitsFromPreviousRunExpression",checked:O,id:"excludeHitsFromPreviousRunExpressionId",onChange:e=>{f(e.target.checked)},label:u.i18n.translate("xpack.stackAlerts.esQuery.ui.excludePreviousHitsExpression",{defaultMessage:"Exclude matches from previous runs"})})),Object(y.jsx)(c.EuiSpacer,{size:"m"}),Object(y.jsx)(S,{fetch:x,copyQuery:g,hasValidationErrors:n}));var P=a(8);const _=["pinFilter","disableFilter"],A=e=>{var t,a,s,r,n,u;const d=Object(g.b)().unifiedSearch,{searchSource:x,errors:O,initialSavedQuery:v,setParam:E,ruleParams:S}=e,[k,F]=Object(i.useState)();Object(i.useEffect)((()=>F(v)),[v]);const[C,A]=Object(i.useReducer)(((e,t)=>((e=>"filter"===e.type||"index"===e.type||"query"===e.type)(t)?(x.setParent(void 0).setField(t.type,t.payload),E("searchConfiguration",x.getSerializedFields())):E(t.type,t.payload),{...e,[t.type]:t.payload})),{index:x.getField("index"),query:x.getField("query"),filter:Object(j.mapAndFlattenFilters)(x.getField("filter")),threshold:null!==(t=S.threshold)&&void 0!==t?t:m.a.THRESHOLD,thresholdComparator:null!==(a=S.thresholdComparator)&&void 0!==a?a:m.a.THRESHOLD_COMPARATOR,timeWindowSize:null!==(s=S.timeWindowSize)&&void 0!==s?s:m.a.TIME_WINDOW_SIZE,timeWindowUnit:null!==(r=S.timeWindowUnit)&&void 0!==r?r:m.a.TIME_WINDOW_UNIT,size:null!==(n=S.size)&&void 0!==n?n:m.a.SIZE,excludeHitsFromPreviousRun:null!==(u=S.excludeHitsFromPreviousRun)&&void 0!==u?u:m.a.EXCLUDE_PREVIOUS_HITS}),{index:M,query:Q,filter:I}=C,z=Object(i.useMemo)((()=>M?[M]:[]),[M]),R=Object(i.useCallback)((e=>A({type:"index",payload:e})),[]),D=Object(i.useCallback)((e=>{A({type:"filter",payload:Object(j.mapAndFlattenFilters)(e)})}),[]),L=Object(i.useCallback)((({query:e})=>{l()(e,Q)||A({type:"query",payload:e||{...Q,query:""}})}),[Q]),W=Object(i.useCallback)((e=>{F(e);const t=e.attributes.filters;t&&A({type:"filter",payload:t})}),[]),H=Object(i.useCallback)((e=>A({type:"timeWindowUnit",payload:e})),[]),V=Object(i.useCallback)((e=>e&&A({type:"timeWindowSize",payload:e})),[]),q=Object(i.useCallback)((e=>e&&A({type:"thresholdComparator",payload:e})),[]),U=Object(i.useCallback)((e=>e&&A({type:"threshold",payload:e})),[]),B=Object(i.useCallback)((e=>A({type:"size",payload:e})),[]),N=Object(i.useCallback)((e=>A({type:"excludeHitsFromPreviousRun",payload:e})),[]),J=`${C.timeWindowSize}${C.timeWindowUnit}`,$=Object(i.useCallback)((()=>{const e=x.createCopy(),t=Object(j.getTime)(x.getField("index"),{from:`now-${J}`,to:"now"});return e.setField("filter",t?[t,...C.filter]:C.filter),e}),[x,J,C]),Z=Object(i.useCallback)((()=>{const e=$();return JSON.stringify(e.getSearchRequestBody(),null,2)}),[$]),G=Object(i.useCallback)((async()=>{const e=$(),{rawResponse:t}=await Object(p.lastValueFrom)(e.fetch$());return{nrOfDocs:w(t.hits.total),timeWindow:J}}),[J,$]);return Object(y.jsx)(i.Fragment,null,Object(y.jsx)(c.EuiTitle,{size:"xs"},Object(y.jsx)("h5",null,Object(y.jsx)(b.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.selectDataViewPrompt",defaultMessage:"Select a data view"}))),Object(y.jsx)(c.EuiSpacer,{size:"s"}),Object(y.jsx)(f,{dataView:M,metadata:e.metadata,onSelectDataView:R,onChangeMetaData:e.onChangeMetaData}),Boolean(null==M?void 0:M.id)&&Object(y.jsx)(o.a.Fragment,null,Object(y.jsx)(c.EuiSpacer,{size:"s"}),Object(y.jsx)(c.EuiTitle,{size:"xs"},Object(y.jsx)("h5",null,Object(y.jsx)(b.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.defineTextQueryPrompt",defaultMessage:"Define your query"}))),Object(y.jsx)(c.EuiSpacer,{size:"xs"}),Object(y.jsx)(d.ui.SearchBar,{appName:h.a,onQuerySubmit:({query:e})=>{(null==e?void 0:e.language)!==Q.language&&A({type:"query",payload:{...Q,language:null==e?void 0:e.language}})},onQueryChange:L,suggestionsSize:"s",displayStyle:"inPage",query:Q,indexPatterns:z,savedQuery:k,filters:I,onFiltersUpdated:D,onClearSavedQuery:()=>{F(void 0),A({type:"query",payload:{...Q,query:""}})},onSavedQueryUpdated:W,onSaved:W,showSaveQuery:!0,showQueryInput:!0,showFilterBar:!0,showDatePicker:!1,showAutoRefreshOnly:!1,showSubmitButton:!1,dateRangeFrom:void 0,dateRangeTo:void 0,hiddenFilterPanelOptions:_})),Object(y.jsx)(c.EuiSpacer,{size:"m"}),Object(y.jsx)(T,{threshold:C.threshold,thresholdComparator:C.thresholdComparator,timeWindowSize:C.timeWindowSize,timeWindowUnit:C.timeWindowUnit,size:C.size,onChangeThreshold:U,onChangeThresholdComparator:q,onChangeWindowSize:V,onChangeWindowUnit:H,onChangeSizeValue:B,errors:O,hasValidationErrors:Object(P.a)(S)||!M,onTestFetch:G,onCopyQuery:Z,excludeHitsFromPreviousRun:C.excludeHitsFromPreviousRun,onChangeExcludeHitsFromPreviousRun:N}),Object(y.jsx)(c.EuiSpacer,null))},M=({ruleParams:e,errors:t,setRuleParams:a,setRuleProperty:s,metadata:r,onChangeMetaData:n})=>{const{thresholdComparator:l,threshold:u,timeWindowSize:p,timeWindowUnit:b,size:j,savedQueryId:h,searchConfiguration:x,excludeHitsFromPreviousRun:O}=e,{data:f}=Object(g.b)(),[v,E]=Object(i.useState)(),[w,S]=Object(i.useState)(),[k,F]=Object(i.useState)(),C=Object(i.useCallback)(((e,t)=>a(e,t)),[a]);return Object(i.useEffect)((()=>{(async()=>{let e=x;if(!x){const t=f.search.searchSource.createEmpty();t.setField("query",f.query.queryString.getDefaultQuery());const a=await f.dataViews.getDefaultDataView();a&&t.setField("index",a),e=t.getSerializedFields()}s("params",{searchConfiguration:e,searchType:d.searchSource,timeWindowSize:null!=p?p:m.a.TIME_WINDOW_SIZE,timeWindowUnit:null!=b?b:m.a.TIME_WINDOW_UNIT,threshold:null!=u?u:m.a.THRESHOLD,thresholdComparator:null!=l?l:m.a.THRESHOLD_COMPARATOR,size:null!=j?j:m.a.SIZE,excludeHitsFromPreviousRun:null!=O?O:m.a.EXCLUDE_PREVIOUS_HITS}),f.search.searchSource.create(e).then(E).catch(F)})()}),[f.search.searchSource,f.dataViews]),Object(i.useEffect)((()=>{h&&f.query.savedQueries.getSavedQuery(h).then(S)}),[f.query.savedQueries,h]),k?Object(y.jsx)(o.a.Fragment,null,Object(y.jsx)(c.EuiCallOut,{color:"danger",iconType:"alert"},Object(y.jsx)("p",null,k.message)),Object(y.jsx)(c.EuiSpacer,{size:"s"})):v?Object(y.jsx)(A,{ruleParams:e,searchSource:v,errors:t,initialSavedQuery:w,setParam:C,metadata:r,onChangeMetaData:n}):Object(y.jsx)(c.EuiEmptyPrompt,{title:Object(y.jsx)(c.EuiLoadingSpinner,{size:"xl"})})};var Q=a(23),I=a(5),z=a(24);const R=({aggs:e,index:t,from:a,to:s,filter:r,size:i,searchAfterSortId:o,sortOrder:n,timeField:l,track_total_hits:c,fields:u,runtime_mappings:d,_source:p})=>{const b=l,j={allow_no_indices:!0,index:t,size:i,ignore_unavailable:!0,track_total_hits:null!=c&&c,body:{docvalue_fields:[l].map((e=>({field:e,format:"strict_date_optional_time"}))),query:{bool:{filter:[r,{bool:{filter:[{range:{[l]:{lte:s,gte:a,format:"strict_date_optional_time"}}}]}},{match_all:{}}]}},...e?{aggs:e}:{},sort:[{[b]:{order:null!=n?n:"asc"}}]},...d?{runtime_mappings:d}:{},...u?{fields:u}:{},...null!=p?{_source:p}:{}};return o?{...j,body:{...j.body,search_after:[o]}}:j};var D=a(30);const{useXJsonMode:L}=Q.XJson,W=({ruleParams:e,setRuleParams:t,setRuleProperty:a,errors:s,data:r})=>{const{index:o,timeField:n,esQuery:l,size:j,thresholdComparator:h,threshold:x,timeWindowSize:g,timeWindowUnit:O,excludeHitsFromPreviousRun:f}=e,[E,S]=Object(i.useState)({...e,timeWindowSize:null!=g?g:m.a.TIME_WINDOW_SIZE,timeWindowUnit:null!=O?O:m.a.TIME_WINDOW_UNIT,threshold:null!=x?x:m.a.THRESHOLD,thresholdComparator:null!=h?h:m.a.THRESHOLD_COMPARATOR,size:null!=j?j:m.a.SIZE,esQuery:null!=l?l:m.a.QUERY,searchType:d.esQuery,excludeHitsFromPreviousRun:null!=f?f:m.a.EXCLUDE_PREVIOUS_HITS}),k=Object(i.useCallback)(((e,a)=>{S((t=>({...t,[e]:a}))),t(e,a)}),[t]),{http:F,docLinks:C}=Object(I.useKibana)().services,[_,A]=Object(i.useState)([]),{convertToJson:M,setXJson:Q,xJson:W}=L(m.a.QUERY);Object(i.useEffect)((()=>{(async()=>{a("params",E),Q(null!=l?l:m.a.QUERY),o&&o.length>0&&await H()})()}),[]);const H=async()=>{if(o){const e=await Object(v.getFields)(F,o);A(e)}},V=Object(i.useCallback)((()=>Object(P.a)(E)),[E]),q=Object(i.useCallback)((async()=>{const e=`${g}${O}`;if(V())return{nrOfDocs:0,timeWindow:e};const t=Object(z.parseDuration)(e),a=JSON.parse(l),s=Date.now(),{rawResponse:i}=await Object(p.lastValueFrom)(r.search.search({params:R({index:o,from:new Date(s-t).toISOString(),to:new Date(s).toISOString(),filter:a.query,size:0,searchAfterSortId:void 0,timeField:n||"",track_total_hits:!0})}));return{nrOfDocs:w(i.hits.total),timeWindow:e}}),[r.search,l,o,n,g,O,V]);return Object(y.jsx)(i.Fragment,null,Object(y.jsx)(c.EuiTitle,{size:"xs"},Object(y.jsx)("h5",null,Object(y.jsx)(b.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.selectIndexPrompt",defaultMessage:"Select an index and time field"}))),Object(y.jsx)(c.EuiSpacer,{size:"s"}),Object(y.jsx)(D.a,{index:o,"data-test-subj":"indexSelectPopover",esFields:_,timeField:n,errors:s,onIndexChange:async t=>{k("index",t),0===t.length?a("params",{...e,index:t,esQuery:m.a.QUERY,size:m.a.SIZE,thresholdComparator:m.a.THRESHOLD_COMPARATOR,timeWindowSize:m.a.TIME_WINDOW_SIZE,timeWindowUnit:m.a.TIME_WINDOW_UNIT,threshold:m.a.THRESHOLD,timeField:""}):await H()},onTimeFieldChange:e=>k("timeField",e)}),Object(y.jsx)(c.EuiSpacer,{size:"s"}),Object(y.jsx)(c.EuiTitle,{size:"xs"},Object(y.jsx)("h5",null,Object(y.jsx)(b.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.defineQueryPrompt",defaultMessage:"Define your query using Query DSL"}))),Object(y.jsx)(c.EuiSpacer,{size:"s"}),Object(y.jsx)(c.EuiFormRow,{id:"queryEditor","data-test-subj":"queryJsonEditor",fullWidth:!0,isInvalid:s.esQuery.length>0,error:s.esQuery,helpText:Object(y.jsx)(c.EuiLink,{href:C.links.query.queryDsl,target:"_blank"},Object(y.jsx)(b.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.queryPrompt.help",defaultMessage:"Elasticsearch Query DSL documentation"}))},Object(y.jsx)(I.CodeEditor,{languageId:"xjson",width:"100%",height:"200px",value:W,onChange:e=>{Q(e),k("esQuery",M(e))},options:{ariaLabel:u.i18n.translate("xpack.stackAlerts.esQuery.ui.queryEditor",{defaultMessage:"Elasticsearch query editor"}),wordWrap:"off",tabSize:2,lineNumbers:"off",lineNumbersMinChars:0,folding:!1,lineDecorationsWidth:0,overviewRulerBorder:!1}})),Object(y.jsx)(c.EuiSpacer,{size:"s"}),Object(y.jsx)(T,{threshold:null!=x?x:m.a.THRESHOLD,thresholdComparator:null!=h?h:m.a.THRESHOLD_COMPARATOR,timeWindowSize:g,timeWindowUnit:O,size:j,onChangeThreshold:e=>k("threshold",e),onChangeThresholdComparator:e=>k("thresholdComparator",e),onChangeWindowSize:e=>k("timeWindowSize",e),onChangeWindowUnit:e=>k("timeWindowUnit",e),onChangeSizeValue:e=>{k("size",e)},errors:s,hasValidationErrors:V(),onTestFetch:q,excludeHitsFromPreviousRun:f,onChangeExcludeHitsFromPreviousRun:e=>{k("excludeHitsFromPreviousRun",e)}}),Object(y.jsx)(c.EuiSpacer,null))},H=[{formType:d.searchSource,label:u.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.kqlOrLuceneFormTypeLabel",{defaultMessage:"KQL or Lucene"}),description:u.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.kqlOrLuceneFormTypeDescription",{defaultMessage:"Use KQL or Lucene to define a text-based query."})},{formType:d.esQuery,label:u.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.queryDslFormTypeLabel",{defaultMessage:"Query DSL"}),description:u.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.queryDslFormTypeDescription",{defaultMessage:"Use the Elasticsearch Query DSL to define a query."})}],V=({searchType:e,onFormTypeSelect:t})=>{if(e){const a=H.find((t=>t.formType===e));return Object(y.jsx)(o.a.Fragment,null,Object(y.jsx)(c.EuiFlexGroup,{alignItems:"center",gutterSize:"s",responsive:!1},Object(y.jsx)(c.EuiFlexItem,null,Object(y.jsx)(c.EuiTitle,{size:"xs","data-test-subj":"selectedRuleFormTypeTitle"},Object(y.jsx)("h5",null,null==a?void 0:a.label))),Object(y.jsx)(c.EuiFlexItem,{grow:!1},Object(y.jsx)(c.EuiButtonIcon,{iconType:"cross",color:"danger","data-test-subj":"queryFormTypeChooserCancel","aria-label":u.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.cancelSelectionAriaLabel",{defaultMessage:"Cancel selection"}),onClick:()=>t(null)}))),Object(y.jsx)(c.EuiText,{color:"subdued",size:"s","data-test-subj":"selectedRuleFormTypeDescription"},null==a?void 0:a.description),Object(y.jsx)(c.EuiSpacer,null))}return Object(y.jsx)(o.a.Fragment,null,Object(y.jsx)(c.EuiTitle,{size:"xs"},Object(y.jsx)("h5",{"data-test-subj":"queryFormTypeChooserTitle"},Object(y.jsx)(b.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.selectQueryFormTypeLabel",defaultMessage:"Select a query type"}))),Object(y.jsx)(c.EuiListGroup,{flush:!0,gutterSize:"m",size:"l",maxWidth:!1},H.map((e=>Object(y.jsx)(c.EuiListGroupItem,{wrapText:!0,key:`form-type-${e.formType}`,"data-test-subj":`queryFormType_${e.formType}`,color:"primary",label:Object(y.jsx)("span",null,Object(y.jsx)("strong",null,e.label),Object(y.jsx)(c.EuiText,{color:"subdued",size:"s"},Object(y.jsx)("p",null,e.description))),onClick:()=>t(e.formType)})))),Object(y.jsx)(c.EuiSpacer,null))};function q(e,t){const a=l()(e.errors,t.errors),s=l()(e.ruleParams,t.ruleParams);return a&&s}const U=Object(i.memo)(M,q);t.default=e=>{var t,a;const{ruleParams:s,errors:n,setRuleProperty:l,setRuleParams:d}=e,p=Object(g.a)(s),b=null===(t=null===(a=e.metadata)||void 0===a?void 0:a.isManagementPage)||void 0===t||t,j=Object(i.useCallback)((e=>{e?d("searchType",e):l("params",{})}),[d,l]),h=u.i18n.translate("xpack.stackAlerts.esQuery.ui.alertParams.fixErrorInExpressionBelowValidationMessage",{defaultMessage:"Expression contains errors."}),x=m.c.find((e=>{var t;return(null===(t=n[e])||void 0===t?void 0:t.length)>=1&&void 0!==s[e]})),O=!!x&&Object(y.jsx)(o.a.Fragment,null,Object(y.jsx)(c.EuiCallOut,{color:"danger",size:"s",title:["index","searchType"].includes(x)?n[x]:h}),Object(y.jsx)(c.EuiSpacer,null));return Object(y.jsx)(o.a.Fragment,null,O,b&&Object(y.jsx)(V,{searchType:s.searchType,onFormTypeSelect:j}),s.searchType&&p&&Object(y.jsx)(U,r()({},e,{ruleParams:s})),s.searchType&&!p&&Object(y.jsx)(W,r()({},e,{ruleParams:s})),Object(y.jsx)(c.EuiHorizontalRule,null))}}}]);